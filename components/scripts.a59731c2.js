!function(){"use strict";d3.charts=d3.charts||{},d3.charts.Grid=function(){function a(){e.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function b(a){x.click(a)}function c(a){var b=a.name||"";i.text(b+"@"+[a.x,a.y])}function d(a){a.each(function(q){function r(a){D=h.selectAll(".chunk").data(a,t),D.enter().append("g").attr("transform","translate(0,0)").attr("class","chunk"),x()}function x(){D.each(y)}function y(a){if(0!==a.chunk.$hash){a.chunk.$hash=0;var d=a.chunk.getTilesArray(),e=d3.select(this).selectAll(".tile").data(d);e.enter().append("g").attr("class","tile").on("click",b).on("mouseenter",c).on("mouseleave",function(){i.text("")}).append("text").attr(v),e.attr("transform",s).select("text").text(m)}}function z(a,d){E=g.selectAll(".bot").data(a,t);var e=E.enter().append("g").attr("class",function(){return"bot"}).on("click",b).on("mouseenter",c).on("mouseleave",function(){i.text("")}).attr("transform",function(a){return s(a.bot)});e.append("circle").attr({r:1.2*p,cx:0,cy:0}),e.append("text").attr(v),E.exit().remove(),A(d)}function A(){E.classed("active",function(a){return a.active}).select("text").text(u),E.attr("transform",function(a){return s(a.bot)})}var B=q[0],C=q[1];e||(k=a[0][0].clientWidth||k,k=k-j.left-j.right,l=a[0][0].clientHeight||l,l=l-j.top-j.bottom,f=d3.select(this).append("svg").attr("width",k).attr("height",l).append("g").attr("transform","translate("+j.left+","+j.right+")").call(w),f.append("rect").attr("width",k).attr("height",l).style("fill","none").style("pointer-events","all"),e=f.append("g"),h=e.append("g").attr("class","tilesLayer"),g=e.append("g").attr("class","botsLayer"),i=f.append("g").attr("class","hover-text").attr("transform","translate(10,20)").append("text").attr({"text-anchor":"start","alignment-baseline":"top",x:0,y:0}).text(""));var D,E;r(B),z(C),d.drawBots=z,d.updateBots=A,d.drawChunks=r,d.updateChunks=x,d.zoomTo=function(a,b){var c=w.scale();a=-n(a)*c+k/2,b=-o(b)*c+l/2,w.translate([a,b]).event(f)}})}var e,f,g,h,i,j={top:-5,right:-5,bottom:-5,left:-5},k=500,l=500,m=_F("t"),n=d3.scale.linear().range([0,k]).domain([0,60]),o=d3.scale.linear().range([0,l]).domain([0,60]),p=n(1),q=_F("x",n),r=_F("y",o),s=function(a){return"translate("+[q(a),r(a)]+")"},t=_F("_id"),u=_F("bot.t"),v={"text-anchor":"middle","alignment-baseline":"middle",x:0,y:0},w=d3.behavior.zoom().scaleExtent([.5,10]).on("zoom",a),x=d3.dispatch("click");return d3.rebind(d,x,"on"),d}}(),angular.module("ePrime",["ngAnimate","ngRoute","ngSanitize","ngMessages","ngTouch","debounce","ui.ace","ui.bootstrap","angularMoment","xeditable","cfp.hotkeys","LocalForageModule","angular-intro","hc.thirdParty","hc.ngEcs","hc.marked"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"components/main/main.html",controller:"MainCtrl as main",resolve:{savedGame:["GAME",function(a){return a.load()}]}}).otherwise({redirectTo:"/"})}]).config(["$logProvider","siteConfig",function(a,b){a.debugEnabled(b.debug)}]).config(["hotkeysProvider",function(a){a.includeCheatSheet=!1}]).config(["$localForageProvider","siteConfig",function(a,b){a.config({name:b.name+b.store})}]).run(["editableOptions",function(a){a.theme="bs3"}]),angular.module("ePrime").constant("siteConfig",{debug:!1,name:"eprime",version:.1,store:0}),function(){"use strict";function a(a,b){return(a%b+b)%b}function b(a,b,c){for(var d=0,e=0,f=0;c>f;f++){var g=1/Math.pow(2,f)/4,h=Math.PI/2*g,i=Math.sin(h),j=Math.cos(h),k=a*i+b*j,l=-a*j+b*i;e+=g,d+=g*Math.abs(noise.perlin2(k/g,l/g))}return 2*d/e}function c(a){var b=Math.exp(-a);return function(){for(var a=0,c=Math.random();c>b;)a++,c*=Math.random();return a}}angular.module("ePrime").constant("TILES",{EMPTY:String.fromCharCode(0),MOUNTAIN:"#",FIELD:".",MINE:"X",HILL:",",BOT:"A",BASE:"@",HOLE:"O"}).factory("Chunk",function(){function b(a,b,e){a=Array.isArray(a)?a:d,this.view=new Uint8ClampedArray(a),this.X=Math.floor(b),this.Y=Math.floor(e),this.size=c,this.$hash=1}var c=60,d=3600;return b.prototype.id=function(){return this.X+","+this.Y},b.prototype.get=function(a,c){return 2===arguments.length&&(a=b.getIndex(a,c)),String.fromCharCode(this.view[a])},b.prototype.getTile=function(a,c){if(angular.isUndefined(c)&&angular.isObject(a)){if(angular.isUndefined(a.x)||angular.isUndefined(a.y))throw"Invalid object passed to Chunk.getTile";c=a.y,a=a.x}var d=b.getIndex(a,c),e=String.fromCharCode(this.view[d]);return b.makeTile(a,c,e)},b.prototype.set=function(a,c,d){return 3===arguments.length?a=b.getIndex(a,c):d=c,this.view[a]=d.charCodeAt(0),this.$hash++,this},b.prototype.getAllTilesArray=function(){for(var a,d,e,f=[],g=this.X*c,h=this.Y*c,i=this.view.length,j=0;i>j;j++)e=this.view[j],e=String.fromCharCode(e),d=Math.floor(j/c),a=j-d*c,f.push(b.makeTile(a+g,d+h,e));return f},b.prototype.getTilesArray=function(){for(var a,d,e,f=[],g=this.X*c,h=this.Y*c,i=this.view.length,j=0;i>j;j++)e=this.view[j],e>0&&(e=String.fromCharCode(e),d=Math.floor(j/c),a=j-d*c,f.push(b.makeTile(a+g,d+h,e)));return f},b.prototype.findTiles=function(a){var d=[];if(1===arguments.length&&"#.XO".indexOf(a)<0)return d;for(var e,f,g,h=this.X*c,i=this.Y*c,j=this.view.length,k=0;j>k;k++)g=this.view[k],g>0&&(g=String.fromCharCode(g),a&&g!==a||(f=Math.floor(k/c),e=k-f*c,d.push(b.makeTile(e+h,f+i,g))));return d},b.getIndex=function(b,d){if(arguments.length<2&&angular.isObject(b)){if(angular.isUndefined(b.x)||angular.isUndefined(b.y))throw"Invalid object pass to Chunk.getIndex";d=b.y,b=b.x}return b=a(Math.floor(b),c),d=a(Math.floor(d),c),d*c+b},b.getChunkId=function(a,b){if(arguments.length<2&&angular.isObject(a)){if(angular.isUndefined(a.x)||angular.isUndefined(a.y))throw"Invalid object pass to Chunk.getChunkId";b=a.y,a=a.x}var d=Math.floor(a/c),e=Math.floor(b/c);return d+","+e},b.makeTile=function(a,b,c){return{x:a,y:b,t:c}},b}).run(["ngEcs","Chunk",function(a,b){a.$c("chunk",b),a.$s("chunks",{$require:["chunk"],$addEntity:function(a){!1==a.chunk.view instanceof Uint8ClampedArray&&(a.chunk.view=new Uint8ClampedArray(a.chunk.view))}})}]).factory("World",["$log","TILES","Chunk","ngEcs",function(a,d,e,f){function g(a,b){this.size=a=a||h,this.seed=b||Math.random()}var h=60,i=c(1.26),j=.05,k=f.systems.chunks.$family;return g.prototype.getHash=function(){return d3.sum(k,_F("chunk.$hash"))},g.prototype.getChunk=function(b,c){var d=e.getChunkId(b,c),g=f.entities[d];if(!g){a.debug("new chunk",d);var h=new e(this.size,b/this.size,c/this.size);g=f.$e(d,{chunk:h})}return g.chunk},g.prototype.getHeight=function(a,c){return noise.seed(this.seed),b((a-30)/h,(c-10)/h,4)},g.prototype.scanTile=function(a,b){var c=this.getChunk(a,b),f=c.get(a,b);if(f===d.EMPTY){var g=this.getHeight(a,b);f=d.FIELD,g>.6?f=d.MOUNTAIN:Math.random()>.98&&(f=d.MINE),c.set(a,b,f)}return e.makeTile(a,b,f)},g.prototype.set=function(a,b,c){this.getChunk(a,b).set(a,b,c)},g.prototype.get=function(a,b){return this.getChunk(a,b).getTile(a,b)},g.prototype.scanRange=function(a,b,c){arguments.length<3&&(c=b,b=a.y,a=a.x),c=c||2;for(var d=[],e=a-c;a+c>=e;e++)for(var f=b-c;b+c>=f;f++){var g=Math.sqrt((a-e)*(a-e)+(b-f)*(b-f));if(c>g){var h=this.scanTile(e,f);d.push(h)}}return d},g.prototype._scanList=function(){for(var a=[],b=0;h>b;b++)for(var c=0;h>c;c++){var e=this.get(b,c);null!==e&&e.t!==d.EMPTY&&a.push(e)}return a},g.prototype.scanChunk=function(a){for(var b=[],c=a.X*h,f=a.Y*h,g=c+h,i=f+h,j=c;g>j;j++)for(var k=f;i>k;k++){var l=a.get(j,k);l!==d.EMPTY&&b.push(e.makeTile(j,k,l))}return b},g.prototype.findTiles=function(a){if(arguments.length<1&&"#.XO".indexOf(a)<0)return[];var b=[];for(var c in k){var d=k[c].chunk;Array.prototype.push.apply(b,d.findTiles(a))}return b},g.prototype.dig=function(a,b){1===arguments.length&&(b=a.y,a=a.x);var c=this.getChunk(a,b),e=c.get(a,b);if(e===d.MINE){var f=i();return f>0&&Math.random()<j&&c.set(a,b,d.HOLE),f}return 0},g.prototype.canMine=function(a,b){return this.getChunk(a,b).get(a,b)===d.MINE},g.prototype.canMove=function(a,b){var c=this.get(a,b);return null!==c&&c.t!==d.MOUNTAIN},g}])}(),function(){"use strict";var a="$bot.unload();\n$bot.charge();\n\nif ($bot.S >=  $bot.mS) {\n  var home = $bot.find('@');\n  $bot.moveTo(home.x,home.y);\n} else if ($bot.E >= 1 && $bot.mine() === false) {\n  var mine = $bot.find('X');\n\n  var x,y;\n  if (mine !== null) {\n     x = mine.x;\n    y = mine.y;\n  } else {\n    x = 2*Math.random()-1+$bot.x;\n    y = 2*Math.random()-1+$bot.y;\n  }\n  $bot.moveTo(x,y);\n}";angular.module("ePrime").config(["thirdPartyProvider",function(a){a.register("Aether")}]).constant("defaultScripts",[{name:"Collect",code:a},{name:"Action",code:"$bot.mine();\n$bot.charge();\n$bot.unload();"},{name:"Upgrade",code:"$bot.upgrade();"},{name:"Construct",code:"$bot.construct();"}]).service("aether",["Aether",function(a){return new a({executionLimit:1e3,functionName:"tick",functionParameters:["console","$bot","$map"],problems:{jshint_W040:{level:"ignore"},aether_MissingThis:{level:"ignore"}},noSerializationInFlow:!0,includeFlow:!1,includeMetrics:!1,includeStyle:!1,protectAPI:!1,yieldAutomatically:!0,protectBuiltins:!1})}]).service("sandBox",["aether","GAME","$log",function(a,b,c){var d={log:console.log.bind(console)},e={get:b.world.get.bind(b.world)};this.run=function(b,f){if(null!==b){var g;"object"==typeof b?(b.$method||(a.transpile(b.code),b.$method=a.createMethod()),g=b.$method):(a.transpile(b),g=a.createMethod());try{var h=g(d,f,e);a.sandboxGenerator(h);for(var i=0,j={done:!1};!j.done&&i++<2e5;)j=h.next();if(!j.done)throw new Error("User script execution limit"+i)}catch(k){var l,m=a.lastStatementRange;return m&&m[0]&&(l=m[0].row+1+":"+m[0].col),c.debug(a),c.warn("User script error",k.message,l||k.stack||""),k.message+l}return!0}}}]).run(["$log","ngEcs","TILES","sandBox","GAME",function(a,b,c,d,e){function f(a){for(var b,c=e.scripts,d=c.length,f=0;d>f;f++)if(b=c[f],b.name===a)return b;return void 0}b.$s("scripts",{$require:["bot","script"],$addEntity:function(b){var c=f(b.script.scriptName);c?b.script.$script=c:a.error("Script not found")},$update:function(){this.$family.forEach(function(a){if(a.script.halted!==!0){var b=f(a.script.scriptName),c=d.run(b,a.$bot);c!==!0&&a.bot.error(c)}})}})}])}(),function(){"use strict";function a(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.max(Math.abs(c),Math.abs(d))}angular.module("ePrime").value("isAt",function(a,b,c){return angular.isObject(b)?b.x===a.x&&b.y===a.y:b===a.x&&c===a.y}).run(["ngEcs",function(b){function c(a){var b=this;["name","x","y","S","mS","E","mE"].forEach(function(c){b[c]=a[c]})}function d(a){var b=this;["name","x","y","S","mS","E","mE","mem"].forEach(function(c){Object.defineProperty(b,c,{get:function(){return a[c]}})})}function e(a){d.call(this,a.bot),this.moveTo=a.bot.moveTo.bind(a.bot),this.move=a.bot.move.bind(a.bot),this.mine=a.bot.mine.bind(a.bot),this.upgrade=a.bot.upgrade.bind(a.bot),this.unload=e.prototype.unload.bind(a.bot),this.charge=e.prototype.charge.bind(a.bot),this.construct=e.prototype.construct.bind(a.bot),this.find=e.prototype.find.bind(a.bot),this.distanceTo=e.prototype.distanceTo.bind(a.bot),this.log=e.prototype.log.bind(a.bot)}e.prototype.unload=function(a){var b=this.findAt(a||"@");return b?this.unloadTo(b):null},e.prototype.charge=function(a){var b=this.findAt(a||"@");return b?b.bot.chargeBot(this.$parent):null},e.prototype.construct=function(a){this.construct(a||null)},e.prototype.distanceTo=function(b){return a(this,b)},e.prototype.find=function(a){var b=this.findNearest(a);return b?(b.$bot&&(b=new c(b.bot)),b):null},e.prototype.log=function(a){this.bot.addAlert("success",a)},b.$s("charging",{$require:["bot"],$update:function(){this.$family.forEach(function(a){var c=a.bot;b.stats.E+=c.charge(c.chargeRate)})}}),b.$s("bots",{$require:["bot"],$addEntity:function(a){a.$bot=new e(a),a.bot.update()}})}]).run(["isAt","TILES","GAME","ngEcs",function(b,c,d,e){function f(a){this.name="",this.t=c.BOT,this.x=0,this.y=0,this.S=0,this.mS=10,this.dS=1,this.E=0,this.dE=.01,this.mE=10,this.active=!1,this.message="",this.alerts=[],this.mem={},this.$parent=a}function g(a,b){return(a%b+b)%b}function h(a){return a=Math.round(a),0===a?0:a/Math.abs(a)}var i=Math.sign||function(a){var b=+a;return 0===b?b:Number.isNaN(b)?b:0>b?-1:1};f.prototype.addAlert=function(a,b){this.alerts.push({type:a,msg:b})},f.prototype.closeAlert=function(a){this.alerts.splice(a,1)},f.prototype.clearLog=function(){this.alerts.splice(0)},f.prototype.error=function(a){this.$parent.script.halted=!0,this.addAlert("danger",a)},f.prototype.charge=function(a){var b=this.E;return this.E=+Math.min(b+a,this.mE).toFixed(4),this.E-b},f.prototype.isAt=function(a,c){return b(this,a,c)},f.prototype.isNotAt=function(a,b){return this.x!==a||this.y!==b},f.prototype.canMove=function(a,b){a=i(a),b=i(b);var c=Math.max(Math.abs(a),Math.abs(b)),e=this.moveCost*c;return d.world.canMove(this.x+a,this.y+b)&&this.E>=e},f.prototype.move=function(a,b){this.obs=!1,a=i(a),b=i(b);var c=Math.max(Math.abs(a),Math.abs(b)),e=this.moveCost*c;return d.world.canMove(this.x+a,this.y+b)&&this.E>=e?(this.last={x:this.x,y:this.y},this.heading={x:a,y:b},this.x+=a,this.y+=b,this.E-=e,d.world.scanRange(this),!0):!1},f.prototype.canWalk=function(a,b){return d.world.canMove(this.x+a,this.y+b)},f.prototype.moveStep=function(a,b){return this.x+=a,this.y+=b,this.E-=this.moveCost,d.world.scanRange(this),!0},f.prototype.canMoveTo=function(a,b){angular.isObject(a)&&(b=a.y,a=a.x);var c=a-this.x,d=b-this.y;return this.canMove(c,d)};var j=[[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1]],k=j.length;f.prototype.moveTo=function(a,c){if(angular.isObject(a)?(c=+a.y||0,a=+a.x||0):(a=+a||0,c=+c||0),b(this,a,c))return this.obs=!1,!0;if(this.E<this.moveCost)return!1;var d=a-this.x,e=c-this.y,f=Math.max(Math.abs(d),Math.abs(e));if(d=h(d/f),e=h(e/f),!this.target||this.target.x!==a||this.target.y!==c){this.target={x:a,y:c};var i={dx:d,dy:e};this.obs=this.obs&&angular.equals(this.heading,i),this.heading=i}var l,m=this.canWalk(d,e);j.forEach(function(a,b){a[0]===d&&a[1]===e&&(l=b)});var n=a-(this.x+d),o=c-(this.y+e),p=Math.max(Math.abs(n),Math.abs(o));this.obs&&m&&p<this.dr&&(this.obs=!1),this.dr=Math.min(f,this.dr);var q;if(this.obs)q=g(this.iHeading-2,k);else{if(m)return this.moveStep(d,e),!0;this.obs=!0,this.dr=f,this.P=[a,c],q=l}for(var r=0;k>r;){var s=j[q];if(this.canWalk(s[0],s[1]))return this.moveStep(s[0],s[1]),this.iHeading=q,!0;q++,q%=k,r++}return!1},f.prototype.canMine=function(){return this.E>=1&&this.S<this.mS&&d.world.get(this.x,this.y).t===c.MINE},f.prototype.mine=function(){if(this.canMine()){this.E--;var a=d.world.dig(this.x,this.y);return a=this.load(a),d.stats.S+=a,a}return!1},f.prototype.load=function(a){var b=this.S;return this.S=Math.min(b+a,this.mS),this.S-b},f.prototype.unload=function(){var a=this.S;return this.S=0,a},f.prototype.chargeBot=function(a){if(b(a.bot,this)){var c=Math.min(10,this.E);return c=a.bot.charge(c),this.E-=c,c}return!1},f.prototype.unloadTo=function(a){if(b(a.bot,this)){var c=this.unload(),d=a.bot.load(c);return this.load(c-d),d}return 0},f.prototype.canUpgrade=function(){return this.S>=10};var l=2,m=.5,n=1,o=2/3,p=m*n/Math.pow(20,o);f.prototype.upgrade=function(){this.S>=10&&(this.S-=10,this.mS+=10,this.mE+=10,this.update())},f.prototype.update=function(){this.mS>=100&&(this.t=c.BASE),this.mass=this.mE+this.mS,this.moveCost=Math.pow(this.mass/20,l),this.chargeRate=p*Math.pow(this.mass,o)},f.prototype.canConstruct=function(){return this.S>=100},f.prototype.construct=function(a){if(this.S>=100){var b=d.ecs.$e({bot:{name:"Rover",x:this.x,y:this.y},render:{}});return a&&b.$add("script",{scriptName:a,halted:!1}),this.S-=100,b}return null},f.prototype.canRelocate=function(){return this.E>=500},f.prototype.scan=function(){return d.world.scan(this)},f.prototype.findAt=function(a){return d.findBotAt(a,this.x,this.y)},f.prototype.findNearest=function(b){var c=this,e=1e10,f=null;return d.scanList(b).forEach(function(b){if(b!==c){var d=b.bot||b,g=a(d,c);e>g&&(f=b,e=g)}}),f},f.prototype.scanList=function(a){var b=this,c=d.scanList(a).filter(function(a){return a!==b});return 0===c.length?[]:(c.forEach(function(a){var c=a.bot||a,d=c.x-b.x,e=c.y-b.y;a.r=Math.max(Math.abs(d),Math.abs(e))}),c.sort(function(a,b){return a.r-b.r}))},e.$c("bot",f)}])}(),function(){"use strict";function a(a){return c.test(Object.prototype.toString.call(a))}function b(c){var d={};for(var e in c)if(c.hasOwnProperty(e)&&"$"!==e.charAt(0)){var f=c[e];!angular.isObject(f)||a(f)||angular.isArray(f)||angular.isDate(f)?"function"!=typeof f&&(d[e]=f):d[e]=b(f)}return d}var c=/^\[object (Uint8(Clamped)?)|(Uint16)|(Uint32)|(Int8)|(Int16)|(Int32)|(Float(32)|(64))Array\]$/;angular.module("ePrime").factory("fpsmeter",function(){var a=new FPSMeter({decimals:0,graph:!0,theme:"dark",left:"5px",top:"30px"});return a.$hide=!0,a.hide(),a}).service("GAME",["$log","$localForage","debounce","ngEcs","World","Chunk","TILES","defaultScripts","fpsmeter",function(a,c,d,e,f,g,h,i,j){function k(a){return function(b){return b=b.bot,b.t===a||b.name===a}}var l=this;l.ecs=e,l.scripts=angular.copy(i),l.scanList=function(a){var b=a?this.bots.filter(k(a)):this.bots,c=this.world.findTiles(a);return c.concat(b)},l.findBotAt=function(a,b,c){for(var d=this.bots.length,e=k(a),f=0;d>f;f++){var g=this.bots[f];if(e(g)&&g.bot.x===b&&g.bot.y===c)return g}return null},l.save=function(){var d={stats:b(l.stats),world:b(l.world),entities:b(e.entities),scripts:l.scripts.map(b)};return c.setItem("saveGame",d).then(function(){l.stats.saved=new Date,a.debug("saved")})},l.load=function(){return c.getItem("saveGame").then(function(b){return b?(a.debug("game loaded",arguments),angular.copy(b.scripts,l.scripts),b.entities&&b.world?(angular.extend(l.world,b.world),angular.extend(l.stats,b.stats),angular.forEach(b.entities,function(a,b){e.$e(b,a)}),void(l.bots=l.ecs.families.bot)):(l.start(),a.debug("saveGame not found"))):(l.start(),a.debug("saveGame not found"))})},l.clear=function(){return c.setItem("saveGame",{scripts:l.scripts.map(b)})},l.setup=function(){return l.world?l.world.$$chunks={}:l.world=new f(60),l.stats=l.ecs.stats={E:0,S:0,turn:0,start:new Date,saved:new Date},l},l.start=function(){var a=l.ecs.$e({$bot:{},bot:{name:"Base",x:30,y:10,S:100,mS:100,E:100,mE:100,t:h.BASE,$game:l},render:{},active:!0});l.bots=l.ecs.families.bot,l.world.scanRange(a.bot);var b=l.world.getChunk(a.bot.x,a.bot.y);return"X"===b.get(a.bot.x,a.bot.y)&&b.set(a.bot.x,a.bot.y,h.FIELD),l};var m=0;e.$s("turn",{$update:function(){l.stats.turn++},$render:function(b){j.tick(),m+=b,m>60&&(a.debug("game saved"),l.save(),m=0)}}),l.setup()}])}(),function(){"use strict";angular.module("ePrime").controller("MainCtrl",["$scope","$compile","$log","$route","$window","$modal","hotkeys","modals","siteConfig","isAt","sandBox","fpsmeter","TILES","GAME",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){0===s.dT&&s.takeTurn()}function p(){s.cheat=!1,s.game=n,s.bots=n.bots,s.bots.forEach(function(a){a.active&&(s.bot=a)})}function q(){s.play(0),n.clear().then(function(){e.location.reload()})}function r(a,b){var c=s.dT;s.play(0),g.pause(),h.pauseConfirm(a,b).result.then(q,function(){n.save(),s.play(c),g.unpause()})}var s=this;i.debug&&g.bindTo(a).add({combo:"f",callback:function(){s.cheat=!0,n.bots.forEach(function(a){a.bot.E=a.bot.mE})}}).add({combo:"g",callback:function(){s.cheat=!0,s.game.world.scanRange(s.bot.bot.x,s.bot.bot.y,40)}}),s.move=function(a,b){s.bot.bot.move(a,b),o()},s.action=function(a){var b=a?a.$bot:s.bot.$bot;b.unload(),b.charge(),b.mine(),o()},s.mine=function(a){for(a=a||s.bot;a.bot.E>1&&a.$bot.mine()!==!1;);o()},s.run=function(a){var b=k.run(a,s.bot.$bot);o(),b!==!0&&s.bot.bot.error(b)};var t=[["q","NW",-1,-1],[["w","up"],"N",0,-1],["e","NE",1,-1],[["a","left"],"W",-1,0],[["d","right"],"E",1,0],["z","SW",-1,1],[["x","down"],"S",0,1],["c","SE",1,1]];t.forEach(function(b){g.bindTo(a).add({combo:b[0],callback:function(){s.move(b[2],b[3])}})}),g.bindTo(a).add({combo:"s",description:"Action (Unload/load/mine)",callback:function(){s.action()}}).add({combo:",",description:"Mine",callback:function(){s.mine()}}).add({combo:".",description:"Pass (take turn)",callback:function(){o()}}).add({combo:"S",description:"Save game",callback:function(){return n.save(),!1}}).add({combo:"?",description:"Show / hide this help menu",callback:function(){s.help()}}).add({combo:"~",description:"Show / hide FPS meter",callback:function(){l.$hide?l.show():l.hide(),l.$hide=!l.$hide}}),s.botChange=function(a){s.bots.forEach(function(b){b.active=b===a,b.active&&(s.bot=a)})},s.help=function(a){var b=s.dT;s.play(0),g.pause(),h.openHelp(a).result.then(null,function(){s.play(b),g.unpause()})},s.reset=function(){r('<h1 class="text-center">Are you sure?<h1>',!0)},s.relocate=function(a){a.bot.canRelocate()&&r('<h1 class="text-center">Congratulations<h1><h3 class="text-center">You have set off to explore another planet.</h3>',!0)},s.save=function(){n.save().then(function(){r('<h1 class="text-center">Game saved.<h1><h4 class="text-center">You can safely close this tab<h4>',!1)})},s.pause=function(){r("",!1)},s.showScripts=function(a){function b(){n.save(),s.play(c)}"string"==typeof a&&n.scripts.forEach(function(b,c){b.name===a&&(a=c)});var c=s.dT;s.play(0),f.open({templateUrl:"components/editor/editor.html",size:"lg",backdrop:"static",controller:"EditorCtrl as editor",resolve:{initialScriptId:function(){return a}}}).result.then(b,b)},p(),s.dT=0,s.takeTurn=function(){n.ecs.$update(),n.ecs.$render()},s.play=function(a){n.ecs.$fps=s.dT=a,a>0?n.ecs.$start():n.ecs.$stop()},a.IntroOptions={disableInteraction:!1,showStepNumbers:!0,steps:[{intro:"<h2>Welcome to Epsilon-prime</h2>In Epsilon-prime your goal is to conquer the planet of ε-prime. You do this by commanding an army of bots to explore and exploit the resources of ε-prime. You can control your bots individually using your mouse and keyboard or by using command scripts written in JavaScript. The game begins with a simple (and very inefficient) set of scripts for exploring and collecting resources. Using just these scripts you could complete this demo in ~2,500 turns. But you can you do better!"},{element:"#left-panel",intro:"The game map is located on the left. Use the mouse and scroll wheel (or touch screen) to pan and zoom the map. The @ mark is your starting base.",position:"right"},{element:"#list",intro:"On the right is a units lists. All your units are listed here.",position:"left"},{element:".list-group-item:nth-child(1)",intro:"At this time you have one unit… the base. Again the base is identified by the @ symbol.",position:"left"},{element:".list-group-item:nth-child(1) .energy-bar",intro:"The red progress bar indicates the unit’s energy storage and capacity. The base unit begins with 100 J of energy. Energy is needed to move and collected resources.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost",intro:"Above the energy indicator you will find the units movement cost and charging rate.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost .movement-cost",intro:"The energy of the base unit is depleted at a very high rate while moving. Notice that the base requires a full charge of 100 J to move one space.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost .recharge-rate",intro:"The base unit recharges at just over 2 J per turn. At this rate a heavy base unit can only move one space every 44 turns.",position:"left"},{element:".list-group-item:nth-child(1) .storage-bar",intro:"The blue progress bar indicates a units resource storage and capacity. Resources are used to upgrade units or construct new units.",position:"left"},{element:".list-group-item:nth-child(1) .construct-button",intro:"Constructing new units costs 100 kg. Construct a new unit now using the button indicated.",position:"left"},{element:".list-group-item:nth-child(2)",intro:"Your new unit will appear in the list...",position:"left",onbeforechange:function(){s.bots.length<2&&this.previousStep()}},{element:"#left-panel",intro:"and on the map indicated on with an A.",position:"right"},{element:".list-group-item:nth-child(2) .energy-cost",intro:"Notice that the movement cost and recharge rate are both lower. This unit can move one space every two turns using its own power generation.",position:"left"},{element:".list-group-item:nth-child(2)",intro:"However small units can also charge from larger units. Make the rover the active unit by clicking the A in the bot list...",position:"left"},{element:".list-group-item:nth-child(2)",intro:'Now press the action key <code class="cfp-hotkeys-key">s</code> to charge the Rover using the Base’s energy. This is the action key.  It is also used to unload any unit storage to the base and to mine resources.',position:"left",onbeforechange:function(){s.bots[1].active||this.previousStep()}},{element:"#left-panel",intro:'You can now begin exploring the map using the <code class="cfp-hotkeys-key">q</code>-<code class="cfp-hotkeys-key">c</code> keys. The letters <code class="cfp-hotkeys-key">qweadzxc</code> are directions of movement (<code class="cfp-hotkeys-key">q</code> for North West, <code class="cfp-hotkeys-key">c</code> for South East, etc).  Imagine your unit is located at the action key <code class="cfp-hotkeys-key">s</code> on your keyboard. ',position:"right"},{element:"#left-panel",intro:'If you encounter an X on the map this is a resource cache (or mine). Collect resources using the action key <code class="cfp-hotkeys-key">s</code>.',position:"right"},{element:".list-group-item:nth-child(2) .energy-bar",intro:"You will notice that the energy depletes as you move.  This is because this unit's movement cost is greater than its recharge rate. You can use all your energy to mine or return to the base periodically to unload and charge...",position:"left"},{element:".list-group-item:nth-child(2) .energy-bar",intro:'Or use the wait key <code class="cfp-hotkeys-key">.</code> to wait one turn an recharge your unit.',position:"left"},{element:"#play-buttons",intro:'You may also use the <i class="fa fa-step-forward"></i> button to advance a turn.',position:"right"},{element:".list-group-item:nth-child(1)",intro:"You can use this dropdown to set a bots automatic actions each turn. Select 'Construct' for the base...",position:"left"},{element:".list-group-item:nth-child(2)",intro:"and 'Collect' for the bot.",position:"left"},{element:"#play-buttons",intro:"Press play button to automatically cycle turns and watch your bots work autonomously.",position:"right"},{element:"#scripts-button",intro:"You can modify the action scripts here.",position:"top"},{element:"#save-button",intro:"Your game is automatically saved approximately every 60 seconds.",position:"left"},{element:"#stats-button",intro:"Check your progress here.",position:"left"},{intro:"<h3>Enjoy</h3>"}]},s.introCounter=1,a.introChange=function(){var a=this,b=a._introItems[a._currentStep];b.onbeforechange&&b.onbeforechange.call(this),s.introCounter=a._currentStep+1;for(var c=a._currentStep;c<this._options.steps.length;c++){b=a._introItems[c];var d=a._options.steps[c];d.element&&(b.element=document.querySelector(d.element),b.position=d.position)}}}])}(),function(){"use strict";angular.module("ePrime").directive("gameMap",["$log","ngEcs",function(a,b){return{restrict:"AE",scope:{item:"=",change:"&"},link:function(a,c){function d(){h.drawChunks(g),h.drawBots(f,b.$delay)}function e(){h.updateChunks(g),h.updateBots(b.$delay)}var f=b.systems.bots.$family,g=b.systems.chunks.$family,h=(new d3.charts.Grid).on("click",function(b){b.bot&&a.$apply(function(){a.change()(b)})});a.$watch("item",function(a){a&&a.bot&&(h.zoomTo(a.bot.x,a.bot.y),h.updateBots(b.$delay))}),b.$s("render",{$addEntity:d,$render:e}),d3.select(c[0]).datum([g,f]).call(h)}}}])}(),function(){"use strict";angular.module("ePrime").directive("botPanel",function(){return{restrict:"A",scope:!0,templateUrl:"components/panels/bot-panel.html",compile:function(a,b){return function(a,c,d){a.bot=a.$parent.$eval(b.botPanel),a.showControls=angular.isDefined(d.showControls)&&a.$parent.$eval(b.showControls),a.$parent.$watch(b.botPanel,function(b){a.bot=b}),a.checkName=function(a){return a.length<3?"Units name must contain at least three characters":!0},a.setScript=function(a,b){return null===b||b.length<1?void a.$remove("script"):void a.$add("script",{scriptName:b,halted:!1})}}}}})}(),function(){"use strict";angular.module("ePrime").service("modals",["$modal",function(a){var b=this;return b.pauseConfirm=function(b,c){return a.open({templateUrl:"components/modals/confirm-model.html",backdrop:"static",keyboard:!0,size:"lg",controller:"ConfirmInstanceCtrl",resolve:{data:function(){return{message:b,showReset:c}}}})},b.openHelp=function(b){return a.open({templateUrl:b||"components/modals/help-model.html",backdrop:"static",keyboard:!0,size:"lg",controller:"HelpInstanceCtrl"})},b}]).controller("HelpInstanceCtrl",["$scope","hotkeys",function(a,b){a.hotkeys=b}]).controller("ConfirmInstanceCtrl",["$scope","data","GAME",function(a,b,c){a.game=c,a.message=b.message,a.showReset=b.showReset}])}(),function(){"use strict";function a(a,b){a.page=1,a.opened=!1,a.search={name:""},a.select=function(b){a.openItem=a.item=b;var c=a.items.indexOf(b);a.page=c+1,a.items.forEach(function(a){a.active=a===b}),a.change()(b)},a.open=function(b){a.select(b),a.page=a.items.indexOf(b)+1,a.opened=!0},a.pageChanged=function(b){var c=a.items[b-1];a.select(c)},a.close=function(){a.opened=!1},b.bindTo(a).add({combo:"k",callback:function(){a.page=Math.min(a.page+1,a.items.length),a.pageChanged(a.page)}}).add({combo:"j",callback:function(){a.page=Math.max(a.page-1,1),a.pageChanged(a.page)}})}a.$inject=["$scope","hotkeys"],angular.module("ePrime").controller("ListController",a).directive("slidingListInject",function(){return{require:"^slidingList",link:function(a,b,c,d,e){var f=d.parent.$new();f[d.valueKey]=a.item,f.opened=a.opened,f.open=d.open,f.$index=a.$index,a.$watch("item",function(a){f[d.valueKey]=a}),a.$watch("opened",function(a){f.opened=a}),e(f,function(a){b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()})})}}}).directive("slidingList",["$parse",function(a){return{restrict:"AE",transclude:!0,scope:{openItem:"=item",change:"&"},controller:"ListController",templateUrl:"components/list/list-template.html",link:function(b,c,d,e){var f=d.slidingList,g=f.match(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),h=g[1],i=g[2];b.items=a(i)(b.$parent),e.parent=b.$parent,e.valueKey=h}}}])}(),function(){"use strict";angular.module("ePrime").controller("EditorCtrl",["$log","$modalInstance","initialScriptId","defaultScripts","GAME","aether","modals",function(a,b,c,d,e,f,g){function h(){var a=i.scripts.map(_F("name"));i.scripts.forEach(function(b,c){for(;a.indexOf(b.name)<c;)b.name=a[c]=b.name+"*"})}var i=this;i.set=function(a){i.script=a},i.reset=function(a){a&&(a.$setPristine(),a.$setUntouched(),a.code.$error={}),i.scripts=angular.copy(e.scripts),i.script=i.scripts[c||0]},i.resetToDefaultScripts=function(){d.forEach(function(a){for(var b=0;b<i.scripts.length;b++)if(i.scripts[b].name===a.name)return void angular.copy(a,i.scripts[b]);i.scripts.push(angular.copy(a))})},i["new"]=function(a,b){a=a||"new",b=b||"$log($bot.name, $bot.x, $bot.y);",i.script={name:a,code:b},i.scripts.push(i.script),h()},i["delete"]=function(a){var b=i.scripts.indexOf(a);i.scripts.splice(b,1),i.script===a&&(i.script=i.scripts[b<i.scripts.length?b:0])},i.update=function(a,b){b.code.$error.syntaxError=!1,a.code&&a.code.length>0&&(f.transpile(a.code),f.problems.errors.length>0&&(b.code.$error.syntaxError=f.problems.errors.map(_F("message")).join("\n")))},i.save=function(){h(),e.scripts=angular.copy(i.scripts),e.scripts.forEach(function(a){a.$method=null}),b.close()},i.aceLoaded=function(a){var b=a.getSession();a.setShowPrintMargin(!1),b.setUseWrapMode(!1),b.setUndoManager(new ace.UndoManager),b.setTabSize(2)},i.help=function(){g.openHelp("components/modals/api-help-model.html")
},i.reset()}])}();