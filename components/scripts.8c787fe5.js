!function(){"use strict";d3.charts=d3.charts||{},d3.charts.Grid=function(){function a(){m.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function b(a){a.each(function(b){function g(){}function h(a){var b=a.name||"";r.text(b+"@"+[a.x,a.y])}d=a[0][0].clientWidth||500,d=d-c.left-c.right;var o,p,q,r,s=b[0],t=b[1];m?(p=m.select(".botsLayer"),q=m.select(".tilesLayer"),r=d3.select(this).select(".hover-text")):(o=d3.select(this).append("svg").attr("width",d).attr("height",e).append("g").attr("transform","translate("+c.left+","+c.right+")").call(n),o.append("rect").attr("width",d).attr("height",e).style("fill","none").style("pointer-events","all"),m=o.append("g"),q=m.append("g").attr("class","tilesLayer"),p=m.append("g").attr("class","botsLayer"),r=o.append("g").attr("class","hover-text").attr("transform","translate(10,20)").append("text").attr({"text-anchor":"start","alignment-baseline":"top",x:0,y:0}).text(""));var u=q.selectAll(".tile").data(s);u.enter().append("g").attr("class","tile").attr("transform",function(a){return"translate("+[j(a),k(a)]+")"}).on("click",g).on("mouseenter",h).on("mouseleave",function(){r.text("")}).append("text").attr(l).text(f),u.attr("transform",function(a){return"translate("+[j(a),k(a)]+")"}).select("text").text(f);var v=p.selectAll(".bot").data(t),w=v.enter().append("g").attr("class",function(a){return"bot bot-"+a.name.toLowerCase()}).on("click",g).on("mouseenter",h).on("mouseleave",function(){r.text("")});w.append("circle").attr({r:1.2*i,cx:0,cy:0}),w.append("text").attr(l),v.classed("active",function(a){return a.active}).attr("transform",function(a){return"translate("+[j(a),k(a)]+")"}).select("text").text(f)})}var c={top:-5,right:-5,bottom:-5,left:-5},d=500-c.left-c.right,e=500-c.top-c.bottom,f=_F("t"),g=d3.scale.linear().range([0,d]).domain([0,60]),h=d3.scale.linear().range([0,e]).domain([0,60]),i=g(1),j=_F("x",g),k=_F("y",h),l={"text-anchor":"middle","alignment-baseline":"middle",x:0,y:0},m=null,n=d3.behavior.zoom().scaleExtent([.5,10]).on("zoom",a);return b}}(),angular.module("myApp",["ngAnimate","ngRoute","ngSanitize","ngMessages","ngTouch","ui.ace","ui.bootstrap","angularMoment","xeditable","cfp.hotkeys","LocalForageModule"]).constant("debug",!0).config(["$routeProvider",function(a){a.when("/",{templateUrl:"components/main/main.html",controller:"MainCtrl as main",resolve:{savedGame:["GAME",function(a){return a.load()}]}}).otherwise({redirectTo:"/"})}]).config(["$logProvider","debug",function(a,b){a.debugEnabled(b)}]).config(["$localForageProvider",function(a){a.config({name:"eprime"})}]).run(["editableOptions",function(a){a.theme="bs3"}]),function(){"use strict";function a(a,b){return(a%b+b)%b}function b(a,b,c){for(var d=0,e=0,f=0;c>f;f++){var g=1/Math.pow(2,f)/4,h=Math.PI/2*g,i=Math.sin(h),j=Math.cos(h),k=a*i+b*j,l=-a*j+b*i;e+=g,d+=g*Math.abs(noise.perlin2(k/g,l/g))}return 2*d/e}function c(a){var b=Math.exp(-a);return function(){for(var a=0,c=Math.random();c>b;)a++,c*=Math.random();return a}}angular.module("myApp").value("TILES",{EMPTY:String.fromCharCode(0),MOUNTAIN:"#",FIELD:"Â·",MINE:"X",HILL:",",BOT:"A",BASE:"@",HOLE:"O"}).factory("Chunk",function(){function b(a,b,c){Array.isArray(a)?(this.length=a.length,this.size=Math.sqrt(a.length),this.view=new Uint8ClampedArray(a)):(this.size=a,this.length=a*a,this.view=new Uint8ClampedArray(this.length)),this.X=Math.floor(b),this.Y=Math.floor(c),this.hash=0}return b.prototype.id=function(){return this.X+","+this.Y},b.prototype.index=function(b,c){var d=this.size;return b=a(Math.floor(b),d),c=a(Math.floor(c),d),c*d+b},b.prototype.get=function(a,b){return 2===arguments.length&&(a=this.index(a,b)),String.fromCharCode(this.view[a])},b.prototype.set=function(a,b,c){return 3===arguments.length?a=this.index(a,b):c=b,this.view[a]=c.charCodeAt(0),this.hash++,this},b}).factory("World",["$log","TILES","Chunk",function(a,d,e){function f(a,b){this.size=a=a||60,this.seed=b||Math.random(),this.$$chunks={}}var g=c(1.26),h=.05;return f.prototype.getHash=function(){return d3.sum(this.$$chunks,_F("hash"))},f.prototype.getChunkId=function(a,b){var c=Math.floor(a/this.size),d=Math.floor(b/this.size);return c+","+d},f.prototype.getChunk=function(b,c){var d=this.getChunkId(b,c),f=this.$$chunks[d];return f||(a.debug("new chunk",d),f=new e(this.size,b/this.size,c/this.size),this.$$chunks[f.id()]=f),f},f.prototype.getIndex=function(a,b){angular.isObject(a)&&(b=a.y,a=a.x);var c=Math.floor(a),d=Math.floor(b);return c%=this.size,d%=this.size,d*this.size+c},f.prototype.getHeight=function(a,c){return noise.seed(this.seed),b((a-30)/this.size,(c-10)/this.size,3)},f.prototype._get=function(a,b){var c=this.getChunk(a,b);return c.get(a,b)},f.prototype._set=function(a,b,c){var d=this.getChunk(a,b);return d.set(a,b,c)},f.prototype.scanTile=function(a,b){var c=this.getChunk(a,b),e=c.get(a,b);if(e===d.EMPTY){var f=this.getHeight(a,b);e=d.FIELD,f>.6?e=d.MOUNTAIN:Math.random()>.98&&(e=d.MINE),c.set(a,b,e)}return{x:a,y:b,t:e,s:!0}},f.prototype.set=function(a,b,c){var d=this.getChunk(a,b);d.set(a,b,c)},f.prototype.get=function(a,b){1===arguments.length&&(b=a.y,a=a.x);var c=this._get(a,b);return c===d.EMPTY?{x:a,y:b,t:c,s:!1}:this.scanTile(a,b)},f.prototype.scanRange=function(a,b,c){arguments.length<3&&(c=b,b=a.y,a=a.x),c=c||2;for(var d=[],e=a-c;a+c>=e;e++)for(var f=b-c;b+c>=f;f++){var g=Math.sqrt((a-e)*(a-e)+(b-f)*(b-f));if(c>g){var h=this.scanTile(e,f);d.push(h)}}return d},f.prototype._scanList=function(){for(var a=this.size,b=this.size,c=[],e=0;a>e;e++)for(var f=0;b>f;f++){var g=this.get(e,f);null!==g&&g.t!==d.EMPTY&&c.push(g)}return c},f.prototype.scanList=function(a){if(angular.isDefined(a)&&a.length>1)return[];var b=this,c=this.size,e=this.size,f=[];return angular.forEach(this.$$chunks,function(g){for(var h=g.X*c,i=g.Y*e,j=h;h+c>j;j++)for(var k=i;i+e>k;k++){var l=b.get(j,k);null!==l&&l.t!==d.EMPTY&&(a&&l.t!==a||f.push(l))}}),f},f.prototype.dig=function(a,b){if(1===arguments.length&&(b=a.y,a=a.x),this.canMine(a,b)){var c=g();return c>0&&Math.random()<h&&this.set(a,b,d.HOLE),c}return 0},f.prototype.canMine=function(a,b){return this.scanTile(a,b).t===d.MINE},f.prototype.canMove=function(a,b){var c=this.get(a,b);return null!==c&&c.t!==d.MOUNTAIN},f}])}(),function(){"use strict";var a=function(a){if(a.unload(),a.charge(),a.S>=a.mS){var b=a.find("@");a.moveTo(b.x,b.y)}else if(a.E>=1&&a.mine()===!1){var c,d,e=a.find("X");null!==e?(c=e.x,d=e.y):(c=2*Math.random()-1+a.x,d=2*Math.random()-1+a.y),a.moveTo(c,d)}}.toString();a=a.substring(a.indexOf("{")+1,a.lastIndexOf("}")),angular.module("myApp").constant("defaultScripts",[{name:"Upgrade",code:"$bot.upgrade();"},{name:"Construct",code:"$bot.construct();"},{name:"Collect",code:a}]).service("aether",function(){var a={executionLimit:1e3,functionName:"tick",functionParameters:["$log","$bot"],problems:{jshint_W040:{level:"ignore"},aether_MissingThis:{level:"ignore"}},noSerializationInFlow:!0,includeFlow:!1,includeMetrics:!1,includeStyle:!1,protectAPI:!1,yieldAutomatically:!0};return new Aether(a)}).service("sandBox",["aether",function(a){var b=this,c=function(){console.log.apply(console,arguments)};return b.run=function(b,d){a.depth=1;var e=b.code;b.$method||(a.transpile(e),b.$method=a.createMethod());var f=b.$method;try{var g=f(c,d);a.sandboxGenerator(g);for(var h=0,i={done:!1};!i.done&&h++<1e5;)i=g.next();if(!i.done)throw new Error("User script execution limit"+h)}catch(j){var k=j.stack||"";return console.log("User script error",j.message,k),j.message}return!0},b}]).value("isAt",function(a,b,c){return angular.isObject(b)?b.x===a.x&&b.y===a.y:b===a.x&&c===a.y}).factory("Bot",["isAt","TILES","$log","sandBox",function(a,b,c,d){function e(a){var b={};return["name","x","y","S","mS","E","mE"].forEach(function(c){Object.defineProperty(b,c,{get:function(){return a[c]}})}),b.move=function(b,c){return a.move(b,c)},b.moveTo=function(b,c){return a.moveTo(b,c)},b.mine=function(){return a.mine()},b.unload=function(c){var d=b.find(c||"Base");return d?a.unloadTo(d):null},b.charge=function(c){var d=b.find(c||"Base");return d?d.chargeBot(a):null},b.upgrade=function(){a.upgrade()},b.construct=function(b){a.construct(b||"Collect")},b.find=function(b){var c=a.scanList(b);return c.length>0?c[0]:null},b}function f(a,c,d,f){this.name=a,h=h||f,this.t=b.BOT,this.x=c,this.y=d,this.S=0,this.mS=10,this.dS=1,this.E=0,this.mE=10,this.manual=!0,this.active=!1,this.message="",this.scriptName="",this.$script=null,this.$bot=e(this)}function g(a){var b=h.scripts.filter(n.eq(a));return b.length>0?b[0]:void 0}var h=null;f.prototype.charge=function(a){var b=this.E;return this.E=+Math.min(b+a,this.mE).toFixed(4),this.E-b},f.prototype.isAt=function(b,c){return a(this,b,c)},f.prototype.mass=function(){return this.mS+this.mE};var i=2;f.prototype.moveCost=function(){return Math.pow(this.mass()/20,i)};var j=.5,k=.1,l=2/3,m=j*k/Math.pow(20,l);f.prototype.chargeRate=function(){return m*Math.pow(this.mass(),l)},f.prototype.canMove=function(a,b){a=Math.sign(a),b=Math.sign(b);var c=Math.max(Math.abs(a),Math.abs(b)),d=this.moveCost()*c;return h.world.canMove(this.x+a,this.y+b)&&this.E>=d},f.prototype.move=function(a,b){a=Math.sign(a),b=Math.sign(b);var c=Math.max(Math.abs(a),Math.abs(b)),d=this.moveCost()*c;return h.world.canMove(this.x+a,this.y+b)&&this.E>=d?(this.last={x:this.x,y:this.y},this.heading={x:a,y:b},this.x+=a,this.y+=b,this.E-=d,h.world.scanRange(this),!0):!1},f.prototype.canMoveTo=function(a,b){angular.isObject(a)&&(b=a.y,a=a.x);var c=a-this.x,d=b-this.y;return this.canMove(c,d)},f.prototype.moveTo=function(b,c){this.target={x:b,y:c},angular.isObject(b)&&(c=b.y,b=b.x);for(var d=b-this.x,e=c-this.y,f=0;7>f;f++){if(d=Math.sign(d),e=Math.sign(e),(!this.obs||!a(this.last,this.x+d,this.y+e))&&this.move(d,e))return this.obs=f>0,!0;var g=d+e;e-=d,d=g}return!1},f.prototype.canMine=function(){return h.world.get(this).t===b.MINE&&this.E>=1&&this.S<this.mS?!0:!1},f.prototype.mine=function(){if(h.world.get(this).t===b.MINE&&this.E>=1&&this.S<this.mS){this.E--;var a=h.world.dig(this);return a=this.load(a),h.S+=a,a}return!1},f.prototype.load=function(a){var b=this.S;return this.S=Math.min(b+a,this.mS),this.S-b},f.prototype.unload=function(){var a=this.S;return this.S=0,a};var n=_F("name");return f.prototype.setCode=function(a){return"string"==typeof a&&(a=g(a)),a?(this.scriptName=a.name,this.$script=a,a):void c.error("Script not found")},f.prototype.run=function(){this.message="",this.manual=!1},f.prototype.stop=function(){this.manual=!0},f.prototype.error=function(a){this.message=a,this.manual=!0},f.prototype.takeTurn=function(a){if(h.E+=this.charge(this.chargeRate()*a),!this.manual&&this.E>1){var b=this.setCode(this.scriptName),c=d.run(b,this.$bot);c!==!0&&this.error(c)}},f.prototype.chargeBot=function(b){if(a(b,this)){var c=Math.min(10,this.E);return c=b.charge(c),this.E-=c,c}return!1},f.prototype.unloadTo=function(b){if(a(b,this)){var c=this.unload(),d=b.load(c);return this.load(c-d),d}return 0},f.prototype.upgrade=function(){this.S>=10&&(this.S-=10,this.mS+=5,this.mE+=5,this.mS>=100&&(this.t="@"))},f.prototype.construct=function(a){if(this.S>=100){var b=new f("Rover",this.x,this.y);return b.scriptName=a||"Collect",b.manual=!angular.isDefined(a),b.$home=this,this.S-=100,h.bots.push(b),b}return null},f.prototype.scan=function(){return h.world.scan(this)},f.prototype.scanList=function(a){var b=this,c=h.scanList(a).filter(function(a){return a!==b});return 0===c.length?[]:(c.forEach(function(a){var c=a.x-b.x,d=a.y-b.y;a.r=Math.max(Math.abs(c),Math.abs(d))}),c.sort(function(a,b){return a.r-b.r}))},f}])}(),function(){"use strict";function a(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function b(a){var b={};for(var c in a)a.hasOwnProperty(c)&&"$"!==c.charAt(0)&&(b[c]=a[c]);return b}angular.module("myApp").service("GAME",["$log","$localForage","World","Bot","Chunk","TILES","defaultScripts",function(c,d,e,f,g,h,i){var j=this;j.scripts=i,j.scanList=function(a){function b(b){return b.t===a||b.name===a}var c=a?this.bots.filter(b):this.bots,d=this.world.scanList(a);return d.concat(c)},j.save=function(){var a={};angular.forEach(j.world.$$chunks,function(b,c){a[c]={X:b.X,Y:b.Y,view:Array.prototype.slice.call(b.view)}});var e={T:j.turn,E:j.E,S:j.S,start:j.start,stats:b(j.stats),world:b(j.world),bots:j.bots.map(b),scripts:j.scripts.map(b),chunks:a};return d.setItem("saveGame",e).then(function(){c.debug("saved")})},j.load=function(){return d.getItem("saveGame").then(function(a){return a?(c.debug("game loaded",arguments),angular.extend(j.world,a.world),angular.copy(a.scripts,j.scripts),angular.copy(a.stats,j.stats),j.world.$$chunks={},angular.forEach(a.chunks,function(a,b){j.world.$$chunks[b]=new g(a.view,a.X,a.Y)}),void a.bots.forEach(function(a,b){var c=j.bots[b];c||(c=new f("",0,1,j),j.bots.push(c)),angular.extend(c,a)})):console.log("saveGame not found")})},j.clear=function(){return d.clear()},j.reset=function(){j.world?j.world.$$chunks={}:j.world=new e(60);var a=new f("Base",30,10,j);a.scriptName="Construct",a.manual=!1,a.S=100,a.E=0,a.dE=.1,a.mE=100,a.mS=100,a.dEdX=1e3,a.t=h.BASE,j.bots=[a],j.world.scanRange(a);var b=a.construct("Collect");return b.active=!0,j.stats={E:0,S:0,turn:0,start:new Date},j},j.takeTurn=function(){a(j.bots.slice(0)).forEach(function(a){a.takeTurn(1)}),j.stats.turn++,j.stats.turn%20===0&&j.save()},j.reset()}])}(),function(){"use strict";angular.module("myApp").controller("MainCtrl",["$scope","$log","$route","$window","$timeout","$modal","hotkeys","modals","debug","isAt","TILES","GAME",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){b.debug("d3 draw");var a=l.world.scanList(),c=l.bots;d3.select("#grid").datum([a,c]).call(s)}function n(){r.cheat=!1,r.game=l,r.home=l.bots[0],r.bot=l.bots[1]}function o(){q(),l.clear().then(function(){d.location.reload()})}function p(a,b){var c=r.dT;r.play(0),h.pauseConfirm(a,b).result.then(o,function(){l.save(),r.play(c)})}function q(){angular.isDefined(u)&&e.cancel(u)}var r=this;r.drawWatch=function(){for(var a=""+l.world.getHash(),b=l.bots.length,c=0;b>c;c++){var d=l.bots[c],e=l.world.getIndex(d);a+=d.t+e+(d===r.bot?"!":"")}return a};var s=new d3.charts.Grid;a.$watch(r.drawWatch,m),r.upgradeBot=function(a){a.upgrade()},r.isAtHome=function(a){return a=a||r.bot,a!==r.home&&j(a,r.bots[0])},r.canMine=function(a){return a=a||r.bot,l.world.get(a.x,a.y).t===k.MINE},r.toggleBot=function(a,b){arguments.length<2&&(b=a.manual),a=a||r.bot,b?a.run():a.stop()},r.canUnload=function(a){return a=a||r.bot,j(a,r.home)&&a.S>0&&r.home.S<r.home.mS},r.canCharge=function(a){return a=a||r.bot,j(a,r.home)&&a.E<a.mE&&r.home.E>0},r.canMineOrUnload=function(a){return a=a||r.bot,a.canMine()||r.canUnload(a)||r.canCharge(a)},r.mineOrUnload=function(a){a=a||r.bot,j(a,r.home)?(a.unloadTo(r.home),r.home.chargeBot(a)):a.mine()},i&&g.bindTo(a).add({combo:"f",callback:function(){r.cheat=!0,l.bots.forEach(function(a){a.E=a.mE})}}).add({combo:"g",callback:function(){r.cheat=!0,r.game.world.scanRange(r.bot.x,r.bot.y,40),m()}});var t=[["q","NW",-1,-1],["w","N",0,-1],["e","NE",1,-1],["a","W",-1,0],["d","E",1,0],["z","SW",-1,1],["x","S",0,1],["c","SE",1,1]];t.forEach(function(b){g.bindTo(a).add({combo:b[0],callback:function(){r.bot.move(b[2],b[3])}})}),g.bindTo(a).add({combo:"s",description:"Action (Unload/load/mine)",callback:function(){r.mineOrUnload(r.bot)}}).add({combo:"r",description:"Manual/auto",callback:function(){r.bot.manual=!r.bot.manual}}).add({combo:"j k",description:"Prev/next bot"}),r.reset=function(){p("Are you sure?",!0)},r.relocate=function(a){a.E>=1e3&&(a.E-=1e3,p("Congratulations",!0))},r.save=function(){l.save().then(function(){p("Game saved.",!1)})},r.pause=function(){p("",!1)},r.showScripts=function(a){function b(){l.save(),r.play(c)}"string"==typeof a&&l.scripts.forEach(function(b,c){b.name===a&&(a=c)});var c=r.dT;r.play(0),f.open({templateUrl:"components/editor/editor.html",size:"lg",backdrop:"static",controller:"EditorCtrl as editor",resolve:{initialScriptId:function(){return a}}}).result.then(b,b)},n(),m(),r.dT=0;var u;r.takeTurn=function(){q(),l.takeTurn(),r.dT>0&&(u=e(r.takeTurn,r.dT))},r.play=function(a){q(),r.dT=a,a>0&&r.takeTurn()},a.$on("$destroy",function(){console.log("destroy"),q()})}])}(),function(){"use strict";angular.module("myApp").directive("botPanel",function(){return{restrict:"A",scope:!0,templateUrl:"components/panels/bot-panel.html",compile:function(a,b){return function(a,c,d){a.bot=a.$parent.$eval(b.botPanel),a.showControls=angular.isDefined(d.showControls)&&a.$parent.$eval(b.showControls),a.$parent.$watch(b.botPanel,function(b){a.bot=b})}}}})}(),function(){"use strict";angular.module("myApp").service("modals",["$modal",function(a){var b=this;return b.pauseConfirm=function(b,c){return a.open({templateUrl:"components/modals/confirm-model.html",backdrop:"static",keyboard:!0,size:"lg",controller:"ConfirmInstanceCtrl",resolve:{data:function(){return{message:b,showReset:c}}}})},b}]).controller("ConfirmInstanceCtrl",["$scope","data","GAME",function(a,b,c){a.game=c,a.message=b.message,a.showReset=b.showReset}])}(),function(){"use strict";function a(a,b){a.page=1,a.item=a.openItem,a.opened=!1,a.search={name:""},a.select=function(b){a.openItem=a.item=b,a.items.forEach(function(a){a.active=a===b})},a.open=function(b){a.select(b),a.page=a.items.indexOf(b)+1,a.opened=!0},a.pageChanged=function(b){var c=a.items[b-1];a.select(c)},a.close=function(){a.opened=!1},b.bindTo(a).add({combo:"k",callback:function(){a.page=Math.min(a.page+1,a.items.length),a.pageChanged(a.page)}}).add({combo:"j",callback:function(){a.page=Math.max(a.page-1,1),a.pageChanged(a.page)}})}a.$inject=["$scope","hotkeys"],angular.module("myApp").controller("ListController",a).directive("slidingListInject",function(){return{require:"^slidingList",link:function(a,b,c,d,e){var f=d.parent.$new();f[d.valueKey]=a.item,f.opened=a.opened,a.$watch("item",function(a){f[d.valueKey]=a}),e(f,function(a){b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()})})}}}).directive("slidingList",function(){return{restrict:"AE",transclude:!0,scope:{openItem:"=item"},controller:"ListController",templateUrl:"components/list/list-template.html",link:function(a,b,c,d){var e=c.slidingList,f=e.match(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),g=f[1],h=f[2];a.items=a.$parent.$eval(h),d.parent=a.$parent,d.valueKey=g}}})}(),function(){"use strict";angular.module("myApp").controller("EditorCtrl",["$log","$modalInstance","initialScriptId","GAME","aether",function(a,b,c,d,e){var f=this;f.set=function(a){f.script=a},f.reset=function(a){a&&(a.$setPristine(),a.$setUntouched(),a.code.$error={}),f.scripts=angular.copy(d.scripts),f.script=f.scripts[c||0]},f["new"]=function(){f.script={name:"new",code:"$log($bot.name, $bot.x, $bot.y);"},f.scripts.push(f.script)},f.update=function(a,b){b.code.$error.syntaxError=!1,a.code&&a.code.length>0&&(e.transpile(a.code),e.problems.errors.length>0&&(b.code.$error.syntaxError=e.problems.errors.map(_F("message")).join("\n")))},f.save=function(){d.scripts=angular.copy(f.scripts),d.scripts.forEach(function(a){a.$method=null}),b.close()},f.aceLoaded=function(a){var b=a.getSession();b.setUndoManager(new ace.UndoManager),b.setTabSize(2)},f.reset()}])}();