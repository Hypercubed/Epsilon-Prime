!function(){"use strict";d3.charts=d3.charts||{},d3.charts.Grid=function(){function a(){e.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function b(a){x.click(a)}function c(a){var b=a.name||"";i.text(b+"@"+[a.x,a.y])}function d(a){a.each(function(q){function r(a){D=h.selectAll(".chunk").data(a,t),D.enter().append("g").attr("transform","translate(0,0)").attr("class","chunk"),x()}function x(){D.each(y)}function y(a){if(0!==a.chunk.$hash){a.chunk.$hash=0;var d=a.chunk.getTilesArray(),e=d3.select(this).selectAll(".tile").data(d);e.enter().append("g").attr("class","tile").on("click",b).on("mouseenter",c).on("mouseleave",function(){i.text("")}).append("text").attr(v),e.attr("transform",s).select("text").text(m)}}function z(a,d){E=g.selectAll(".bot").data(a,t);var e=E.enter().append("g").attr("class",function(){return"bot"}).on("click",b).on("mouseenter",c).on("mouseleave",function(){i.text("")}).attr("transform",function(a){return s(a.bot)});e.append("circle").attr({r:1.2*p,cx:0,cy:0}),e.append("text").attr(v),E.exit().remove(),A(d)}function A(){E.classed("active",function(a){return a.active}).select("text").text(u),E.attr("transform",function(a){return s(a.bot)})}var B=q[0],C=q[1];e||(k=a[0][0].clientWidth||k,k=k-j.left-j.right,l=a[0][0].clientHeight||l,l=l-j.top-j.bottom,f=d3.select(this).append("svg").attr("width",k).attr("height",l).append("g").attr("transform","translate("+j.left+","+j.right+")").call(w),f.append("rect").attr("width",k).attr("height",l).style("fill","none").style("pointer-events","all"),e=f.append("g"),h=e.append("g").attr("class","tilesLayer"),g=e.append("g").attr("class","botsLayer"),i=f.append("g").attr("class","hover-text").attr("transform","translate(10,20)").append("text").attr({"text-anchor":"start","alignment-baseline":"top",x:0,y:0}).text(""));var D,E;r(B),z(C),d.drawBots=z,d.updateBots=A,d.drawChunks=r,d.updateChunks=x,d.zoomTo=function(a,b){var c=w.scale();a=-n(a)*c+k/2,b=-o(b)*c+l/2,w.translate([a,b]).event(f)}})}var e,f,g,h,i,j={top:-5,right:-5,bottom:-5,left:-5},k=500,l=500,m=_F("t"),n=d3.scale.linear().range([0,k]).domain([0,60]),o=d3.scale.linear().range([0,l]).domain([0,60]),p=n(1),q=_F("x",n),r=_F("y",o),s=function(a){return"translate("+[q(a),r(a)]+")"},t=_F("_id"),u=_F("bot.t"),v={"text-anchor":"middle","alignment-baseline":"middle",x:0,y:0},w=d3.behavior.zoom().scaleExtent([.5,10]).on("zoom",a),x=d3.dispatch("click");return d3.rebind(d,x,"on"),d}}(),angular.module("ePrime",["ngAnimate","ngRoute","ngSanitize","ngMessages","ngTouch","debounce","ui.ace","ui.bootstrap","angularMoment","xeditable","cfp.hotkeys","LocalForageModule","angular-intro","hc.thirdParty","hc.ngEcs","hc.marked"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"components/main/main.html",controller:"MainCtrl as main",resolve:{savedGame:["GAME",function(a){return a.load()}]}}).otherwise({redirectTo:"/"})}]).config(["$logProvider","siteConfig",function(a,b){a.debugEnabled(b.debug)}]).config(["hotkeysProvider",function(a){a.includeCheatSheet=!1}]).config(["$localForageProvider","siteConfig",function(a,b){a.config({name:b.name+b.store})}]).run(["editableOptions",function(a){a.theme="bs3"}]),angular.module("ePrime").constant("siteConfig",{debug:!1,name:"eprime",version:.1,store:0}),function(){"use strict";function a(a,b){return(a%b+b)%b}function b(a,b,c){for(var d=0,e=0,f=0;c>f;f++){var g=1/Math.pow(2,f)/4,h=Math.PI/2*g,i=Math.sin(h),j=Math.cos(h),k=a*i+b*j,l=-a*j+b*i;e+=g,d+=g*Math.abs(noise.perlin2(k/g,l/g))}return 2*d/e}function c(a){var b=Math.exp(-a);return function(){for(var a=0,c=Math.random();c>b;)a++,c*=Math.random();return a}}angular.module("ePrime").constant("TILES",{EMPTY:String.fromCharCode(0),MOUNTAIN:"#",FIELD:".",MINE:"X",HILL:",",BOT:"A",BASE:"@",HOLE:"O"}).factory("Chunk",function(){function b(a,b,e){a=Array.isArray(a)?a:d,this.view=new Uint8ClampedArray(a),this.X=Math.floor(b),this.Y=Math.floor(e),this.size=c,this.$hash=1}var c=60,d=3600;return b.prototype.id=function(){return this.X+","+this.Y},b.prototype.get=function(a,c){return 2===arguments.length&&(a=b.getIndex(a,c)),String.fromCharCode(this.view[a])},b.prototype.getTile=function(a,c){if(angular.isUndefined(c)&&angular.isObject(a)){if(angular.isUndefined(a.x)||angular.isUndefined(a.y))throw"Invalid object passed to Chunk.getTile";c=a.y,a=a.x}var d=b.getIndex(a,c),e=String.fromCharCode(this.view[d]);return b.makeTile(a,c,e)},b.prototype.set=function(a,c,d){return 3===arguments.length?a=b.getIndex(a,c):d=c,this.view[a]=d.charCodeAt(0),this.$hash++,this},b.prototype.getAllTilesArray=function(){for(var a,d,e,f=[],g=this.X*c,h=this.Y*c,i=this.view.length,j=0;i>j;j++)e=this.view[j],e=String.fromCharCode(e),d=Math.floor(j/c),a=j-d*c,f.push(b.makeTile(a+g,d+h,e));return f},b.prototype.getTilesArray=function(){for(var a,d,e,f=[],g=this.X*c,h=this.Y*c,i=this.view.length,j=0;i>j;j++)e=this.view[j],e>0&&(e=String.fromCharCode(e),d=Math.floor(j/c),a=j-d*c,f.push(b.makeTile(a+g,d+h,e)));return f},b.prototype.findTiles=function(a){var d=[];if(1===arguments.length&&"#.XO".indexOf(a)<0)return d;for(var e,f,g,h=this.X*c,i=this.Y*c,j=this.view.length,k=0;j>k;k++)g=this.view[k],g>0&&(g=String.fromCharCode(g),a&&g!==a||(f=Math.floor(k/c),e=k-f*c,d.push(b.makeTile(e+h,f+i,g))));return d},b.getIndex=function(b,d){if(arguments.length<2&&angular.isObject(b)){if(angular.isUndefined(b.x)||angular.isUndefined(b.y))throw"Invalid object pass to Chunk.getIndex";d=b.y,b=b.x}return b=a(Math.floor(b),c),d=a(Math.floor(d),c),d*c+b},b.getChunkId=function(a,b){if(arguments.length<2&&angular.isObject(a)){if(angular.isUndefined(a.x)||angular.isUndefined(a.y))throw"Invalid object pass to Chunk.getChunkId";b=a.y,a=a.x}var d=Math.floor(a/c),e=Math.floor(b/c);return d+","+e},b.makeTile=function(a,b,c){return{x:a,y:b,t:c}},b}).run(["ngEcs","Chunk",function(a,b){a.$c("chunk",b),a.$s("chunks",{$require:["chunk"],$addEntity:function(a){!1==a.chunk.view instanceof Uint8ClampedArray&&(a.chunk.view=new Uint8ClampedArray(a.chunk.view))}})}]).factory("World",["$log","TILES","Chunk","ngEcs",function(a,d,e,f){function g(a,b){this.size=a=a||h,this.seed=b||Math.random()}var h=60,i=c(1.26),j=.05,k=f.systems.chunks.$family;return g.prototype.getHash=function(){return d3.sum(k,_F("chunk.$hash"))},g.prototype.getChunk=function(b,c){var d=e.getChunkId(b,c),g=f.entities[d];if(!g){a.debug("new chunk",d);var h=new e(this.size,b/this.size,c/this.size);g=f.$e(d,{chunk:h})}return g.chunk},g.prototype.getHeight=function(a,c){return noise.seed(this.seed),b((a-30)/h,(c-10)/h,4)},g.prototype.scanTile=function(a,b){var c=this.getChunk(a,b),f=c.get(a,b);if(f===d.EMPTY){var g=this.getHeight(a,b);f=d.FIELD,g>.6?f=d.MOUNTAIN:Math.random()>.98&&(f=d.MINE),c.set(a,b,f)}return e.makeTile(a,b,f)},g.prototype.set=function(a,b,c){this.getChunk(a,b).set(a,b,c)},g.prototype.get=function(a,b){return this.getChunk(a,b).getTile(a,b)},g.prototype.scanRange=function(a,b,c){arguments.length<3&&(c=b,b=a.y,a=a.x),c=c||2;for(var d=[],e=a-c;a+c>=e;e++)for(var f=b-c;b+c>=f;f++){var g=Math.sqrt((a-e)*(a-e)+(b-f)*(b-f));if(c>g){var h=this.scanTile(e,f);d.push(h)}}return d},g.prototype._scanList=function(){for(var a=[],b=0;h>b;b++)for(var c=0;h>c;c++){var e=this.get(b,c);null!==e&&e.t!==d.EMPTY&&a.push(e)}return a},g.prototype.scanChunk=function(a){for(var b=[],c=a.X*h,f=a.Y*h,g=c+h,i=f+h,j=c;g>j;j++)for(var k=f;i>k;k++){var l=a.get(j,k);l!==d.EMPTY&&b.push(e.makeTile(j,k,l))}return b},g.prototype.findTiles=function(a){if(arguments.length<1&&"#.XO".indexOf(a)<0)return[];var b=[];for(var c in k){var d=k[c].chunk;Array.prototype.push.apply(b,d.findTiles(a))}return b},g.prototype.dig=function(a,b){1===arguments.length&&(b=a.y,a=a.x);var c=this.getChunk(a,b),e=c.get(a,b);if(e===d.MINE){var f=i();return f>0&&Math.random()<j&&c.set(a,b,d.HOLE),f}return 0},g.prototype.canMine=function(a,b){return this.getChunk(a,b).get(a,b)===d.MINE},g.prototype.canMove=function(a,b){var c=this.get(a,b);return null!==c&&c.t!==d.MOUNTAIN},g}])}(),function(){"use strict";var a="$bot.unload();\n$bot.charge();\n\nif ($bot.S >=  $bot.mS) {\n  var home = $bot.find('@');\n  $bot.moveTo(home.x,home.y);\n} else if ($bot.E >= 1 && $bot.mine() === false) {\n  var mine = $bot.find('X');\n\n  var x,y;\n  if (mine !== null) {\n     x = mine.x;\n    y = mine.y;\n  } else {\n    x = 2*Math.random()-1+$bot.x;\n    y = 2*Math.random()-1+$bot.y;\n  }\n  $bot.moveTo(x,y);\n}";angular.module("ePrime").config(["thirdPartyProvider",function(a){a.register("Aether")}]).constant("defaultScripts",[{name:"Collect",code:a},{name:"Action",code:"$bot.mine();\n$bot.charge();\n$bot.unload();"},{name:"Upgrade",code:"$bot.upgrade();"},{name:"Construct",code:"$bot.construct();"}]).service("aether",["Aether",function(a){return new a({executionLimit:1e3,functionName:"tick",functionParameters:["console","$bot","$map"],problems:{jshint_W040:{level:"ignore"},aether_MissingThis:{level:"ignore"}},noSerializationInFlow:!0,includeFlow:!1,includeMetrics:!1,includeStyle:!1,protectAPI:!1,yieldAutomatically:!0,protectBuiltins:!1})}]).service("sandBox",["aether","GAME","$log",function(a,b,c){var d=this,e={log:console.log.bind(console)},f={get:b.world.get.bind(b.world)};d.run=function(b,d){if(null!==b){var g;"object"==typeof b?(b.$method||(a.transpile(b.code),b.$method=a.createMethod()),g=b.$method):(a.transpile(b),g=a.createMethod());var h={done:!1};try{var i=g(e,d,f);a.sandboxGenerator(i);for(var j=0;!h.done&&j++<2e5;)h=i.next();h.done||(h.error="User script execution limit")}catch(k){var l,m=a.lastStatementRange;m&&m[0]&&(l=m[0].row+1+":"+m[0].col),c.debug(a),c.warn("User script error",k.message,l||k.stack||""),h.error=k.message+l}return h}}}]).run(["$log","ngEcs","TILES","sandBox","GAME",function(a,b,c,d,e){function f(a){for(var b,c=e.scripts,d=c.length,f=0;d>f;f++)if(b=c[f],b.name===a)return b;return void 0}b.$s("scripts",{acc:0,interval:1,$require:["bot","script"],$addEntity:function(b){var c=f(b.script.scriptName);c?b.script.$script=c:a.error("Script not found")},$update:function(){e.stats.turn++;for(var a,b=-1,c=this.$family,g=c.length;++b<g;)if(a=c[b],a.script.halted!==!0&&a.script.skip!==!0){if(!(a.bot.E<1))for(var h=f(a.script.scriptName);a.bot.E>1;){var i=d.run(h,a.$bot);if(i.error)a.bot.error(i.error);else if(i.done)break}}else a.script.skip=!1}})}])}(),function(){"use strict";function a(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.max(Math.abs(c),Math.abs(d))}function b(a,b,c){return angular.isObject(b)?b.x===a.x&&b.y===a.y:b===a.x&&c===a.y}function c(a,b){return(a%b+b)%b}function d(a){return a=Math.round(a),0===a?0:a/Math.abs(a)}var e=Math.sign||function(a){var b=+a;return 0===b?b:Number.isNaN(b)?b:0>b?-1:1};angular.module("ePrime").value("isAt",b).run(["ngEcs",function(b){function c(a){var b=this;["name","x","y","S","mS","E","mE"].forEach(function(c){b[c]=a[c]})}function d(a){var b=this;["name","x","y","S","mS","E","mE","mem"].forEach(function(c){Object.defineProperty(b,c,{get:function(){return a[c]}})})}function e(a){d.call(this,a.bot),this.moveTo=a.bot.moveTo.bind(a.bot),this.move=a.bot.move.bind(a.bot),this.mine=a.bot.mine.bind(a.bot),this.upgrade=a.bot.upgrade.bind(a.bot),this.unload=e.prototype.unload.bind(a.bot),this.charge=e.prototype.charge.bind(a.bot),this.construct=e.prototype.construct.bind(a.bot),this.find=e.prototype.find.bind(a.bot),this.distanceTo=e.prototype.distanceTo.bind(a.bot),this.log=e.prototype.log.bind(a.bot)}e.prototype.unload=function(a){var b=this.findAt(a||"@");return b?this.unloadTo(b):null},e.prototype.charge=function(a){var b=this.findAt(a||"@");return b?b.bot.chargeBot(this.$parent):null},e.prototype.construct=function(a){this.construct(a||null)},e.prototype.distanceTo=function(b){return a(this,b)},e.prototype.find=function(a){var b=this.findNearest(a);return b?(b.$bot&&(b=new c(b.bot)),b):null},e.prototype.log=function(a){this.bot.addAlert("success",a)},b.$s("bots",{$require:["bot"],$addEntity:function(a){a.$bot=new e(a),a.bot.update()},$updateEach:function(a,c){var d=a.bot,e=+Math.min(d.chargeRate*c,d.mE-d.E);d.E+=e,b.stats.E+=e}})}]).run(["ngEcs",function(a){function b(){this.queue=[]}b.prototype.push=function(a){this.queue.push(a)},b.prototype.next=function(){return this.queue.shift()},b.prototype.clear=function(){this.queue=[]},a.$c("action",b),a.$s("action",{$require:["bot","action"],$updateEach:function(a){if(a.script&&(a.script.skip=a.action.queue.length>0),!(a.bot.E<1)&&a.action.queue.length>0){var b=a.action.next(),c=b(a);c.next&&a.action.push(c.next)}}})}]).run(["isAt","TILES","GAME","ngEcs",function(b,f,g,h){function i(a){this.name="",this.t=f.BOT,this.x=0,this.y=0,this.S=0,this.mS=10,this.dS=1,this.E=0,this.dE=.01,this.mE=10,this.active=!1,this.message="",this.alerts=[],this.mem={},this.$parent=a}var j={mS0:10,mE0:10,DIS:2,CHAR:.5,I:.5,E:2/3,constructCost:20};i.prototype.addAlert=function(a,b){this.alerts.push({type:a,msg:b})},i.prototype.closeAlert=function(a){this.alerts.splice(a,1)},i.prototype.clearLog=function(){this.alerts.splice(0)},i.prototype.error=function(a){this.$parent.script.halted=!0,this.addAlert("danger",a)},i.prototype.charge=function(a){var b=this.E;return this.E=+Math.min(b+a,this.mE).toFixed(4),this.E-b},i.prototype.isAt=function(a,c){return b(this,a,c)},i.prototype.isNotAt=function(a,b){return this.x!==a||this.y!==b},i.prototype.canMove=function(a,b){a=e(a),b=e(b);var c=Math.max(Math.abs(a),Math.abs(b)),d=this.moveCost*c;return g.world.canMove(this.x+a,this.y+b)&&this.E>=d},i.prototype.move=function(a,b){this.obs=!1,a=e(a),b=e(b);var c=Math.max(Math.abs(a),Math.abs(b)),d=this.moveCost*c;return g.world.canMove(this.x+a,this.y+b)&&this.E>=d?(this.last={x:this.x,y:this.y},this.heading={x:a,y:b},this.x+=a,this.y+=b,this.E-=d,g.world.scanRange(this),!0):!1},i.prototype.canWalk=function(a,b){return g.world.canMove(this.x+a,this.y+b)},i.prototype.moveStep=function(a,b){return this.x+=a,this.y+=b,this.E-=this.moveCost,g.world.scanRange(this),!0},i.prototype.canMoveTo=function(a,b){angular.isObject(a)&&(b=a.y,a=a.x);var c=a-this.x,d=b-this.y;return this.canMove(c,d)};var k=[[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1],[0,1]],l=k.length;i.prototype.moveTo=function(a,e){if(angular.isObject(a)?(e=+a.y||0,a=+a.x||0):(a=+a||0,e=+e||0),b(this,a,e))return this.obs=!1,!0;if(this.E<this.moveCost)return!1;var f=a-this.x,g=e-this.y,h=Math.max(Math.abs(f),Math.abs(g));if(f=d(f/h),g=d(g/h),!this.target||this.target.x!==a||this.target.y!==e){this.target={x:a,y:e};var i={dx:f,dy:g};this.obs=this.obs&&angular.equals(this.heading,i),this.heading=i}var j,m=this.canWalk(f,g);k.forEach(function(a,b){a[0]===f&&a[1]===g&&(j=b)});var n=a-(this.x+f),o=e-(this.y+g),p=Math.max(Math.abs(n),Math.abs(o));this.obs&&m&&p<this.dr&&(this.obs=!1),this.dr=Math.min(h,this.dr);var q;if(this.obs)q=c(this.iHeading-2,l);else{if(m)return this.moveStep(f,g),!0;this.obs=!0,this.dr=h,this.P=[a,e],q=j}for(var r=0;l>r;){var s=k[q];if(this.canWalk(s[0],s[1]))return this.moveStep(s[0],s[1]),this.iHeading=q,!0;q++,q%=l,r++}return!1},i.prototype.canMine=function(){return this.E>=1&&this.S<this.mS&&g.world.get(this.x,this.y).t===f.MINE},i.prototype.mine=function(){if(this.canMine()){this.E--;var a=g.world.dig(this.x,this.y);return a=this.load(a),g.stats.S+=a,a}return!1},i.prototype.load=function(a){var b=this.S;return this.S=Math.min(b+a,this.mS),this.S-b},i.prototype.unload=function(){var a=this.S;return this.S=0,a},i.prototype.chargeBot=function(a){if(b(a.bot,this)){var c=Math.min(10,this.E);return c=a.bot.charge(c),this.E-=c,c}return!1},i.prototype.unloadTo=function(a){if(b(a.bot,this)){var c=this.unload(),d=a.bot.load(c);return this.load(c-d),d}return 0},i.prototype.canUpgrade=function(){return this.S>=this.upgradeCost};var m=10*j.CHAR*j.I/Math.pow(20,j.E);i.prototype.upgrade=function(){this.S>=this.upgradeCost&&(this.S-=this.upgradeCost,this.mS+=10,this.mE+=10,this.update())},i.prototype.update=function(){this.mass=this.mE+this.mS,this.moveCost=Math.pow(this.mass/20,j.DIS),this.chargeRate=m*Math.pow(this.mass,j.E),this.upgradeCost=.5*this.mass,this.constructCost=j.constructCost,this.mS>=this.constructCost&&(this.t=f.BASE)},i.prototype.canConstruct=function(){return this.S>=j.constructCost},i.prototype.construct=function(a){if(this.S>=j.constructCost){var b=g.ecs.$e({bot:{name:"Rover",x:this.x,y:this.y},action:{},render:{}});return a&&b.$add("script",{scriptName:a,halted:!1}),this.S-=this.constructCost,b}return null},i.prototype.canRelocate=function(){return this.E>=500},i.prototype.scan=function(){return g.world.scan(this)},i.prototype.findAt=function(a){return g.findBotAt(a,this.x,this.y)},i.prototype.findNearest=function(b){var c=this,d=1e10,e=null;return g.scanList(b).forEach(function(b){if(b!==c){var f=b.bot||b,g=a(f,c);d>g&&(e=b,d=g)}}),e},i.prototype.scanList=function(a){var b=this,c=g.scanList(a).filter(function(a){return a!==b});return 0===c.length?[]:(c.forEach(function(a){var c=a.bot||a,d=c.x-b.x,e=c.y-b.y;a.r=Math.max(Math.abs(d),Math.abs(e))}),c.sort(function(a,b){return a.r-b.r}))},h.$c("bot",i)}])}(),function(){"use strict";function a(a){return c.test(Object.prototype.toString.call(a))}function b(c){var d={};for(var e in c)if(c.hasOwnProperty(e)&&"$"!==e.charAt(0)){var f=c[e];!angular.isObject(f)||a(f)||angular.isArray(f)||angular.isDate(f)?"function"!=typeof f&&(d[e]=f):d[e]=b(f)}return d}var c=/^\[object (Uint8(Clamped)?)|(Uint16)|(Uint32)|(Int8)|(Int16)|(Int32)|(Float(32)|(64))Array\]$/;angular.module("ePrime").factory("fpsmeter",function(){var a=new FPSMeter({decimals:0,graph:!0,theme:"dark",left:"5px",top:"30px"});return a.$hide=!0,a.hide(),a}).service("GAME",["$log","$localForage","debounce","ngEcs","World","Chunk","TILES","defaultScripts","fpsmeter","$modal",function(a,c,d,e,f,g,h,i,j,k){function l(a){return function(b){return b=b.bot,b.t===a||b.name===a}}var m=this;m.ecs=e,e.$interval=.1,m.dT=1,m.scripts=angular.copy(i),m.scanList=function(a){var b=a?this.bots.filter(l(a)):this.bots,c=this.world.findTiles(a);return c.concat(b)},m.findBotAt=function(a,b,c){for(var d=this.bots.length,e=l(a),f=0;d>f;f++){var g=this.bots[f];if(e(g)&&g.bot.x===b&&g.bot.y===c)return g}return null},m.save=function(){var d={stats:b(m.stats),world:b(m.world),entities:b(e.entities),scripts:m.scripts.map(b)};return c.setItem("saveGame",d).then(function(){m.stats.saved=new Date,a.debug("saved")})},m.load=function(){return c.getItem("saveGame").then(function(b){return b?(a.debug("game loaded",arguments),angular.copy(b.scripts,m.scripts),b.entities&&b.world?(angular.extend(m.world,b.world),angular.extend(m.stats,b.stats),angular.forEach(b.entities,function(a,b){e.$e(b,a)}),void(m.bots=m.ecs.families.bot)):(a.debug("saveGame not found"),m.start())):(a.debug("saveGame not found"),m.start())})},m.clear=function(){return c.setItem("saveGame",{scripts:m.scripts.map(b)})},m.setup=function(){return m.world?m.world.$$chunks={}:m.world=new f(60),m.stats=m.ecs.stats={E:0,S:0,turn:0,start:new Date,saved:new Date},m},m.start=function(){var a=e.$e({$bot:{},bot:{name:"Base",x:30,y:10,E:10,$game:m},action:{},render:{},active:!0});m.bots=e.families.bot,m.world.scanRange(a.bot,2);var b=m.world.getChunk(a.bot.x,a.bot.y);return"X"===b.get(a.bot.x,a.bot.y)&&b.set(a.bot.x,a.bot.y,h.FIELD),k.open({keyboard:!1,backdrop:"static",templateUrl:"components/modals/start-model.html"}).result.then(function(a){m.tutorial=a})},e.$s("fpsMeter",{$update:function(){j.tick()}}),e.$s("saveGame",{interval:60,$update:function(){a.debug("game saved"),m.save()}}),m.setup()}])}(),function(){"use strict";angular.module("ePrime").service("gameIntro",["$rootScope","ngEcs",function(a,b){function c(){var b=this;e(b);var c=b._introItems[b._currentStep];c.onbeforechange&&(a.$apply(function(){c.onbeforechange.call(b)}),e(b))}function d(){var b=this;f.counter=b._currentStep+1,e(b);var c=b._introItems[b._currentStep];c.onafterchange&&(a.$apply(function(){c.onafterchange.call(b)}),e(b))}function e(a){for(var b=0;b<a._options.steps.length;b++){var c=a._introItems[b],d=a._options.steps[b];d.element&&(c.element=document.querySelector(d.element),c.position=d.position)}}var f=this;f.beforeChange=c,f.afterChange=d,f.counter=1;var g=b.families.bot,h=g[0].bot,i=[{element:"#left-panel",intro:"The game map is located on the left. Use the mouse and scroll wheel (or touch screen) to pan and zoom the map. The A mark is your starting unit.",position:"right"},{element:"#list",intro:"On the right is your units list.",position:"left"},{element:".list-group-item:nth-child(1)",intro:"At this time you have one unit. Here also the starting unit is identified by the <i>A</i> symbol.",position:"left"},{element:".list-group-item:nth-child(1) .energy-bar",intro:"This progress bar indicates the unit’s energy and energy storage capacity. The unit begins with no energy but can harvest upto 10 J. Energy is needed to move and collect resources.",position:"left"},{element:"#play-buttons",intro:'Press the wait key <code class="cfp-hotkeys-key">.</code> or use use the <i class="fa fa-step-forward"></i> button to advance several turns.',position:"right"},{onafterchange:function(){h.E<2&&this.previousStep().refresh()},element:".list-group-item:nth-child(1) .energy-bar",intro:"Your unit’s energy will increase.",position:"left"},{element:"#movement-buttons",intro:'You can now begin exploring the map using the <code class="cfp-hotkeys-key">q</code>-<code class="cfp-hotkeys-key">c</code> keys. The letters <code class="cfp-hotkeys-key">qweadzxc</code> are directions of movement (<code class="cfp-hotkeys-key">q</code> for North West, <code class="cfp-hotkeys-key">c</code> for South East, etc).  Imagine your unit is located at the action key <code class="cfp-hotkeys-key">s</code> on your keyboard. ',position:"right"},{element:".list-group-item:nth-child(1) .energy-bar",intro:"You will notice that the energy depletes as you move.  This is because this unit's movement cost is greater than its recharge rate.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost",intro:"Above the energy indicator you will find the units movement cost and charging rate.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost .movement-cost",intro:"Notice that the unit requires 1 J to move one space.",position:"left"},{element:".list-group-item:nth-child(1) .energy-cost .recharge-rate",intro:"The unit recharges at 5 J per second. At this rate a unit can move five (5) spaces every second, not counting stored energy.",position:"left"},{element:"#left-panel",intro:'If you encounter an X on the map this is a resource cache (or mine). Collect resources using the action key <code class="cfp-hotkeys-key">s</code>.',position:"right"},{element:".list-group-item:nth-child(1) .storage-bar",intro:"This progress bar indicates a unit’s resources and storage capacity. Resources are used to upgrade units or construct new units.",position:"left"},{element:".list-group-item:nth-child(1) .upgrade-button",intro:"Upgrading units costs 10 kg.  You should pause the tutorial now and explore.  Return to the tutrial when you have upgraded your unit.  <p /><b>If you continue the tutorial now we will automatically upgrade your unit.  Normally this would cost resources that you need to collect.</b>",position:"left"},{onafterchange:function(){h.mS<20&&(h.S=20,h.upgrade())},element:".list-group-item:nth-child(1) .energy-cost",intro:"Notice that the movement cost and recharge rate are both higher after upgrading. Now the unit requires a more turns to move one space even though recharge rate is higher.  Also notice that the unit is indicated with a <i>@</i>",position:"left"},{element:".list-group-item:nth-child(1) .construct-button",intro:"Once a unit has a storage capacity greater than 20 it is able to construct new units.  Constructing new units costs 20 kg.  You should pause the tutorial and continue exploring to collect 20 kg of storage. <br /><b>If you continue the tutorial we will construct a new unit for you.  Again this would normally cost resources that you must to collect.",position:"left"},{onbeforechange:function(){g.length<2&&(h.S=20,h.construct())},element:".list-group-item:nth-child(2)",intro:"Your new unit will appear in the list...",position:"left"},{element:"#left-panel",intro:"and on the map indicated on with an A.",position:"right"},{element:".list-group-item:nth-child(2) .energy-cost",intro:"Notice that the movement cost and recharge rate are again low.",position:"left"},{element:".list-group-item:nth-child(2)",intro:"Small units can also charge from larger units. Make the new unit active unit by clicking the <i>A</i> in the bot list...",position:"left"},{element:".list-group-item:nth-child(2)",intro:'Now press the action key <code class="cfp-hotkeys-key">s</code> to charge the Rover using the Base’s energy. This is the action key.  It is also used to unload any unit storage to the base and to mine resources.',position:"left",onafterchange:function(){g[1].active||this.previousStep()}},{element:".list-group-item:nth-child(1)",intro:"You can use this dropdown to set a bots automatic actions each turn. Select 'Construct' for the base...",position:"left"},{element:".list-group-item:nth-child(2)",intro:"and 'Collect' for the bot.",position:"left"},{element:"#play-buttons",intro:"Press play button to automatically cycle turns and watch your bots work autonomously.",position:"right"},{element:"#scripts-button",intro:"You can modify the action scripts here.",position:"top"},{element:"#save-button",intro:"Your game is automatically saved approximately every 60 seconds.",position:"left"},{element:"#stats-button",intro:"Check your progress here.",position:"left"},{intro:"How quickly can you collect 500 kg in the base unit?  <h3>Good luck!</h3>"}];f.options={disableInteraction:!1,showStepNumbers:!0,steps:i}}])}(),function(){"use strict";angular.module("ePrime").controller("MainCtrl",["$scope","$compile","$log","$route","$window","$modal","hotkeys","modals","siteConfig","isAt","sandBox","fpsmeter","gameIntro","TILES","GAME",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){t.play(0),o.clear().then(function(){e.location.reload()})}function q(a,b){r(),h.pauseConfirm(a,b).result.then(p,function(){o.save(),s()})}function r(){w=t.dT,t.play(0),g.pause(),o.ecs.$stop()}function s(){t.play(w),g.unpause(),o.ecs.$start()}var t=this;t.dT=6,t.cheat=!1,t.game=o,t.bots=o.bots,t.intro=m,t.bots.forEach(function(a){a.active&&(t.bot=a)}),a.autoStart=!!o.tutorial,delete o.tutorial,o.ecs.$start(),i.debug&&g.bindTo(a).add({combo:"f",callback:function(){t.cheat=!0,o.bots.forEach(function(a){a.bot.E=a.bot.mE})}}).add({combo:"g",callback:function(){t.cheat=!0,t.game.world.scanRange(t.bot.bot.x,t.bot.bot.y,40)}});const u={done:!0};t.wait=function(){var a=t.bot;a.action.push(function(){return u})},t.move=function(a,b){t.bot.action.push(function c(d){return d.bot.E>=d.bot.moveCost||d.bot.moveCost>=d.bot.mE?(d.bot.move(a,b),u):{next:c}})},t.action=function(a){a=a||t.bot,a.action.push(function(a){var b=a.$bot;return b.unload(),b.charge(),b.mine(),u})},t.mine=function(a){a=a||t.bot,a.action.push(function b(a){var c=a.$bot;return a.bot.E>=1?(c.mine(),u):{next:b}})};var v=[["q","NW",-1,-1],["w","N",0,-1],["e","NE",1,-1],["a","W",-1,0],["d","E",1,0],["z","SW",-1,1],["x","S",0,1],["c","SE",1,1]];v.forEach(function(b){g.bindTo(a).add({combo:b[0],callback:function(){t.move(b[2],b[3])}})}),g.bindTo(a).add({combo:"s",description:"Action (Unload/load/mine)",callback:function(){t.action()}}).add({combo:",",description:"Mine",callback:function(){t.mine()}}).add({combo:".",description:"Pass (take turn)",callback:function(){t.wait()}}).add({combo:"S",description:"Save game",callback:function(){return o.save(),!1}}).add({combo:"?",description:"Show / hide this help menu",callback:function(){t.help()}}).add({combo:"~",description:"Show / hide FPS meter",callback:function(){l.$hide?l.show():l.hide(),l.$hide=!l.$hide}}),t.botChange=function(a){t.bots.forEach(function(b){b.active=b===a,b.active&&(t.bot=a)})};var w;t.help=function(a){r(),h.openHelp(a).result.then(null,s)},t.reset=function(){q('<h1 class="text-center">Are you sure?<h1>',!0)},t.relocate=function(a){a.bot.canRelocate()&&q('<h1 class="text-center">Congratulations<h1><h3 class="text-center">You have set off to explore another planet.</h3>',!0)},t.save=function(){o.save().then(function(){q('<h1 class="text-center">Game saved.<h1><h4 class="text-center">You can safely close this tab<h4>',!1)})},t.pause=function(){q("",!1)},t.showScripts=function(a){function b(){o.save(),s()}"string"==typeof a&&o.scripts.forEach(function(b,c){b.name===a&&(a=c)}),r(),f.open({templateUrl:"components/editor/editor.html",size:"lg",backdrop:"static",controller:"EditorCtrl as editor",resolve:{initialScriptId:function(){return a}}}).result.then(b,b)},t.takeTurn=function(){o.ecs.systems.scripts.acc=1/t.dT},t.play=function(a){t.dT=a,o.ecs.systems.scripts.interval=1/a}}])}(),function(){"use strict";angular.module("ePrime").directive("gameMap",["$log","ngEcs",function(a,b){return{restrict:"AE",scope:{item:"=",change:"&"},link:function(a,c){function d(){h.drawChunks(g),h.drawBots(f,b.$delay)}function e(){h.updateChunks(g),h.updateBots(b.$delay)}var f=b.systems.bots.$family,g=b.systems.chunks.$family,h=(new d3.charts.Grid).on("click",function(b){b.bot&&a.$apply(function(){a.change()(b)})});a.$watch("item",function(a){a&&a.bot&&(h.zoomTo(a.bot.x,a.bot.y),h.updateBots(b.$delay))}),b.$s("render",{$addEntity:d,$render:e}),d3.select(c[0]).datum([g,f]).call(h)}}}])}(),function(){"use strict";angular.module("ePrime").directive("botPanel",function(){return{restrict:"A",scope:!0,templateUrl:"components/panels/bot-panel.html",compile:function(a,b){return function(a,c,d){a.bot=a.$parent.$eval(b.botPanel),a.showControls=angular.isDefined(d.showControls)&&a.$parent.$eval(b.showControls),a.$parent.$watch(b.botPanel,function(b){a.bot=b}),a.checkName=function(a){return a.length<3?"Units name must contain at least three characters":!0},a.setScript=function(a,b){return null===b||b.length<1?void a.$remove("script"):void a.$add("script",{scriptName:b,halted:!1})}}}}})}(),function(){"use strict";angular.module("ePrime").service("modals",["$modal",function(a){var b=this;return b.pauseConfirm=function(b,c){return a.open({templateUrl:"components/modals/confirm-model.html",backdrop:"static",keyboard:!0,size:"lg",controller:"ConfirmInstanceCtrl",resolve:{data:function(){return{message:b,showReset:c}}}})},b.openHelp=function(b){return a.open({templateUrl:b||"components/modals/help-model.html",backdrop:"static",keyboard:!0,size:"lg",controller:"HelpInstanceCtrl"})},b}]).controller("HelpInstanceCtrl",["$scope","hotkeys",function(a,b){a.hotkeys=b}]).controller("ConfirmInstanceCtrl",["$scope","data","GAME",function(a,b,c){a.game=c,a.message=b.message,a.showReset=b.showReset}])}(),function(){"use strict";function a(a,b){a.page=1,a.opened=!1,a.search={name:""},a.select=function(b){a.openItem=a.item=b;var c=a.items.indexOf(b);a.page=c+1,a.items.forEach(function(a){a.active=a===b}),a.change()(b)},a.open=function(b){a.select(b),a.page=a.items.indexOf(b)+1,a.opened=!0},a.pageChanged=function(b){var c=a.items[b-1];a.select(c)},a.close=function(){a.opened=!1},b.bindTo(a).add({combo:"k",callback:function(){a.page=Math.min(a.page+1,a.items.length),a.pageChanged(a.page)}}).add({combo:"j",callback:function(){a.page=Math.max(a.page-1,1),a.pageChanged(a.page)}})}a.$inject=["$scope","hotkeys"],angular.module("ePrime").controller("ListController",a).directive("slidingListInject",function(){return{require:"^slidingList",link:function(a,b,c,d,e){var f=d.parent.$new();f[d.valueKey]=a.item,f.opened=a.opened,f.open=d.open,f.$index=a.$index,a.$watch("item",function(a){f[d.valueKey]=a}),a.$watch("opened",function(a){f.opened=a}),e(f,function(a){b.empty(),b.append(a),b.on("$destroy",function(){f.$destroy()})})}}}).directive("slidingList",["$parse",function(a){return{restrict:"AE",transclude:!0,scope:{openItem:"=item",change:"&"},controller:"ListController",templateUrl:"components/list/list-template.html",link:function(b,c,d,e){var f=d.slidingList,g=f.match(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+as\s+([\s\S]+?))?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),h=g[1],i=g[2];
b.items=a(i)(b.$parent),b.opened=b.items.length<2,e.parent=b.$parent,e.valueKey=h}}}])}(),function(){"use strict";angular.module("ePrime").controller("EditorCtrl",["$log","$modalInstance","initialScriptId","defaultScripts","GAME","aether","modals",function(a,b,c,d,e,f,g){function h(){var a=i.scripts.map(_F("name"));i.scripts.forEach(function(b,c){for(;a.indexOf(b.name)<c;)b.name=a[c]=b.name+"*"})}var i=this;i.set=function(a){i.script=a},i.reset=function(a){a&&(a.$setPristine(),a.$setUntouched(),a.code.$error={}),i.scripts=angular.copy(e.scripts),i.script=i.scripts[c||0]},i.resetToDefaultScripts=function(){d.forEach(function(a){for(var b=0;b<i.scripts.length;b++)if(i.scripts[b].name===a.name)return void angular.copy(a,i.scripts[b]);i.scripts.push(angular.copy(a))})},i["new"]=function(a,b){a=a||"new",b=b||"$log($bot.name, $bot.x, $bot.y);",i.script={name:a,code:b},i.scripts.push(i.script),h()},i["delete"]=function(a){var b=i.scripts.indexOf(a);i.scripts.splice(b,1),i.script===a&&(i.script=i.scripts[b<i.scripts.length?b:0])},i.update=function(a,b){b.code.$error.syntaxError=!1,a.code&&a.code.length>0&&(f.transpile(a.code),f.problems.errors.length>0&&(b.code.$error.syntaxError=f.problems.errors.map(_F("message")).join("\n")))},i.save=function(){h(),e.scripts=angular.copy(i.scripts),e.scripts.forEach(function(a){a.$method=null}),b.close()},i.aceLoaded=function(a){var b=a.getSession();a.setShowPrintMargin(!1),b.setUseWrapMode(!1),b.setUndoManager(new ace.UndoManager),b.setTabSize(2)},i.help=function(){g.openHelp("components/modals/api-help-model.html")},i.reset()}])}();